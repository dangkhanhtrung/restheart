"use strict";var __awaiter=this&&this.__awaiter||function(s,n,u,i){return new(u=u||Promise)(function(e,r){function t(e){try{a(i.next(e))}catch(e){r(e)}}function o(e){try{a(i.throw(e))}catch(e){r(e)}}function a(r){r.done?e(r.value):new u(function(e){e(r.value)}).then(t,o)}a((i=i.apply(s,n||[])).next())})},__generator=this&&this.__generator||function(t,o){var a,s,n,e,u={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return e={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,s&&(n=2&r[0]?s.return:r[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,r[1])).done)return n;switch(s=0,n&&(r=[2&r[0],n.value]),r[0]){case 0:case 1:n=r;break;case 4:return u.label++,{value:r[1],done:!1};case 5:u.label++,s=r[1],r=[0];continue;case 7:r=u.ops.pop(),u.trys.pop();continue;default:if(!(n=0<(n=u.trys).length&&n[n.length-1])&&(6===r[0]||2===r[0])){u=0;continue}if(3===r[0]&&(!n||r[1]>n[0]&&r[1]<n[3])){u.label=r[1];break}if(6===r[0]&&u.label<n[1]){u.label=n[1],n=r;break}if(n&&u.label<n[2]){u.label=n[2],u.ops.push(r);break}n[2]&&u.ops.pop(),u.trys.pop();continue}r=o.call(t,u)}catch(e){r=[6,e],s=0}finally{a=n=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var Router=require("koa-router"),oai_response_1=require("../oai/core/oai-response"),core_oai_provider_1=require("../oai/core/core-oai-provider"),mongodb_mapper_1=require("../oai/oai-provider/repository/mongodb-mapper"),mongodbDcMapper=new mongodb_mapper_1.MongodbDcMapper,oaisRouter=new Router({prefix:"/oai"});oaisRouter.get("/",function(o,a){return __awaiter(_this,void 0,void 0,function(){var r,t;return __generator(this,function(e){switch(e.label){case 0:return o.response.type="xml",o.query.metadataPrefix&&o.query.set&&"Identify"===o.query.verb?[4,mongodbDcMapper.mapIdentify(o.request.header.user,o.query.metadataPrefix,o.query.set)]:[3,2];case 1:return r=e.sent(),o.response.body=oai_response_1.generateResponse(o.query,o.request.header.host+o.request.url,r),[3,9];case 2:return o.query.metadataPrefix&&o.query.set&&"ListRecords"===o.query.verb?[4,mongodbDcMapper.mapListRecords(o)]:[3,4];case 3:return r=e.sent(),o.response.body=oai_response_1.generateResponse(o.query,o.request.header.host+o.request.url,r),[3,9];case 4:return o.query.metadataPrefix&&o.query.set&&o.query.identifier&&"GetRecord"===o.query.verb?[4,mongodbDcMapper.mapGetRecord(o.query)]:[3,6];case 5:return null===(r=e.sent())?(t={baseUrl:o.request.header.host+o.request.url},o.response.body=oai_response_1.generateException(t,core_oai_provider_1.EXCEPTION_CODES.BAD_ARGUMENT)):0===r.GetRecord.length?(t={baseUrl:o.request.header.host+o.request.url},o.response.body=oai_response_1.generateException(t,core_oai_provider_1.EXCEPTION_CODES.NO_RECORDS_MATCH)):o.response.body=oai_response_1.generateResponse(o.query,o.request.header.host+o.request.url,r),[3,9];case 6:return"ListMetadataFormats"!==o.query.verb?[3,8]:[4,mongodbDcMapper.mapListMetadataFormats(o.request.header.user,o.query.metadataPrefix,o.query.metadataPrefix)];case 7:return r=e.sent(),o.response.body=oai_response_1.generateResponse(o.query,o.request.header.host+o.request.url,r),[3,9];case 8:t={baseUrl:o.request.header.host+o.request.url},o.response.body=oai_response_1.generateException(t,core_oai_provider_1.EXCEPTION_CODES.BAD_VERB),e.label=9;case 9:return a(),[2]}})})}),oaisRouter.get("/secure",function(t,o){return __awaiter(_this,void 0,void 0,function(){var r;return __generator(this,function(e){switch(e.label){case 0:return t.response.type="xml",t.query.metadataPrefix&&t.query.set&&"ListRecords"===t.query.verb?[4,mongodbDcMapper.mapListRecordsAsync(t)]:[3,2];case 1:r=e.sent(),t.response.body=oai_response_1.generateResponse(t.query,t.request.header.host+t.request.url,r),e.label=2;case 2:return o(),[2]}})})}),exports.default=oaisRouter;