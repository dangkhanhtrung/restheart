"use strict";var __awaiter=this&&this.__awaiter||function(n,c,o,u){return new(o=o||Promise)(function(e,s){function r(e){try{t(u.next(e))}catch(e){s(e)}}function a(e){try{t(u.throw(e))}catch(e){s(e)}}function t(s){s.done?e(s.value):new o(function(e){e(s.value)}).then(r,a)}t((u=u.apply(n,c||[])).next())})},__generator=this&&this.__generator||function(r,a){var t,n,c,e,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function s(s){return function(e){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;o;)try{if(t=1,n&&(c=2&s[0]?n.return:s[0]?n.throw||((c=n.return)&&c.call(n),0):n.next)&&!(c=c.call(n,s[1])).done)return c;switch(n=0,c&&(s=[2&s[0],c.value]),s[0]){case 0:case 1:c=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!c||s[1]>c[0]&&s[1]<c[3])){o.label=s[1];break}if(6===s[0]&&o.label<c[1]){o.label=c[1],c=s;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(s);break}c[2]&&o.ops.pop(),o.trys.pop();continue}s=a.call(r,o)}catch(e){s=[6,e],n=0}finally{t=c=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var arrays_1=require("./arrays"),config_1=require("../config"),httpRequest_1=require("../api/httpRequest"),msg403={message:"Access denied!",error:{statusCode:403,status:403,code:403,message:"Access denied!",name:"permission_denied"}},msg409={message:"Conflict data!",error:{statusCode:409,status:409,code:409,message:"Conflict data!",name:"conflict_data"}},msgChange={message:"status"};exports.deleteResourceCollection=function(a,e,s,t){return __awaiter(_this,void 0,void 0,function(){var s,r;return __generator(this,function(e){switch(e.label){case 0:return[4,(s=new httpRequest_1.default(config_1.PROJECT_SERVICE_HOST)).fetch_rest(a+"/"+t.storeDb+"/"+t.shortName+"?pagesize=0",{})];case 1:return r=e.sent(),[4,s.delete_rest(a+"/"+t.storeDb+"/"+t.shortName,{headers:{"If-Match":r.headers.etag}})];case 2:return 204===e.sent().status?[2,null]:[2,msg409]}})})},exports.permission=function(w,x,$,A,e,U){return __awaiter(_this,void 0,void 0,function(){var s,r,a,t,n,c,o,u,i,l,d,f,m,h,_,p,g,y,v,b,E,R;return __generator(this,function(e){switch(e.label){case 0:return s={},r=new httpRequest_1.default(config_1.PROJECT_SERVICE_HOST),a=$,0<String($).indexOf("?")&&(a=String($).substring(0,String($).indexOf("?"))),t=a.split("/"),t[0],t[1],n=t[2],c=t[3],o=null==x||""===x,u={},null==n?[3,2]:[4,r.fetch_rest(w+"/vuejx_cfg/vuejx_collection",{params:{filter:{shortName:n},keys:{rightMode:1,publicAccess:1,accessRoles:1,accessUsers:1,accessEmails:1}}})];case 1:0<(i=e.sent()).data.length&&(u=i.data[0]),e.label=2;case 2:return 0===u.publicAccess&&o?[2,msg403]:"GET"!==A.method?[3,10]:(void 0!==A.query.filter&&(s=JSON.parse(A.query.filter)),(l=0!==u.rightMode)?[3,5]:(d=!o)?[4,arrays_1.found(x.role,["admin"])]:[3,4]);case 3:d=e.sent(),e.label=4;case 4:l=d,e.label=5;case 5:return l?[3,9]:[3,6];case 6:return f=[],void 0!==s.$and&&null!==s.$and||(s.$and=[]),(m=!o)?[4,arrays_1.foundScope(x.scope,f)]:[3,8];case 7:m=!e.sent(),e.label=8;case 8:if(m)return[2,msg403];if(o)void 0!==A.query.email&&null!==A.query.email&&""!==A.query.email&&(s.$and.push({accessEmails:{$exists:!0}}),s.$and.push({"accessEmails.shortName":A.query.email}));else{for(s.$and.push({openAccess:1}),h=[],_=0,p=x.role;_<p.length;_++)g=p[_],h.push({"accessRoles.shortName":g});h.push({username:x.username}),h.push({"accessUsers.shortName":x.username}),s.$and.push({$or:h})}e.label=9;case 9:return void 0!==s.$and&&0===s.$and.length?delete s.$and:void 0!==s.$and&&void 0!==s.$and.$or&&0===s.$and.$or.length&&delete s.$and.$or,[2,s];case 10:return(y=2===u.rightMode)?[3,12]:[4,arrays_1.found(x.role,["admin"])];case 11:y=e.sent(),e.label=12;case 12:return y?[2,null]:1===u.publicAccess&&o?[2,msg403]:0===u.publicAccess&&o?[2,msg403]:[4,arrays_1.foundPermission(x.role,u.accessRoles)];case 13:return v=e.sent(),"POST"!==A.method?[3,15]:(b=msg403,v.some(function(e){if(2===e)return!0})?[2,null]:[4,arrays_1.foundPermission(x.role,u.accessUsers)]);case 14:return(v=e.sent()).some(function(e){if(2===e)return!0})?[2,null]:[2,b];case 15:return"PUT"!==A.method?[3,22]:[4,r.fetch_rest(w+"/vuejx_cfg/vuejx_collection/"+c,{params:{keys:{username:1,openAccess:1,accessRoles:1,accessUsers:1,accessEmails:1}}})];case 16:return void 0!==(E=e.sent()).data.username&&E.data.username===x.username?[2,null]:[4,arrays_1.foundPermission(x.role,E.data.accessRoles)];case 17:return v=e.sent(),(R=v.some(function(e){if(3===e)return!0}))?[2,null]:!R&&(R=v.some(function(e){if(2===e)return!0}))?(U.openAccess=E.data.openAccess,U.accessRoles=E.data.accessRoles,U.accessUsers=E.data.accessUsers,U.accessEmails=E.data.accessEmails,[2,null]):R?[3,19]:[4,arrays_1.foundPermission(x.role,E.data.accessUsers)];case 18:if(v=e.sent(),R=v.some(function(e){if(3===e)return!0}))return[2,null];if(!R&&(R=v.some(function(e){if(2===e)return!0})))return U.openAccess=E.data.openAccess,U.accessRoles=E.data.accessRoles,U.accessUsers=E.data.accessUsers,U.accessEmails=E.data.accessEmails,[2,null];e.label=19;case 19:return R?[3,21]:[4,arrays_1.foundPermission(x.role,E.data.accessEmails)];case 20:if(v=e.sent(),R=v.some(function(e){if(3===e)return!0}))return[2,null];if(!R&&(R=v.some(function(e){if(2===e)return!0})))return U.openAccess=E.data.openAccess,U.accessRoles=E.data.accessRoles,U.accessUsers=E.data.accessUsers,U.accessEmails=E.data.accessEmails,[2,null];e.label=21;case 21:return[2,msg403];case 22:return"DELETE"!==A.method?[3,27]:[4,r.fetch_rest(w+"/vuejx_cfg/vuejx_collection/"+c,{params:{keys:{username:1,openAccess:1,accessRoles:1,accessUsers:1,accessEmails:1}}})];case 23:return void 0!==(E=e.sent()).data.username&&E.data.username===x.username?[2,null]:[4,arrays_1.foundPermission(x.role,E.data.accessRoles)];case 24:return v=e.sent(),(R=v.some(function(e){if(4===e)return!0}))?[2,null]:R?[3,26]:[4,arrays_1.foundPermission(x.role,E.data.accessUsers)];case 25:if(v=e.sent(),R=v.some(function(e){if(4===e)return!0}))return[2,null];e.label=26;case 26:return[2,msg403];case 27:return[2,s]}})})},exports.permissionQuery=function(e,s){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},exports.permissionQueryES=function(e,s){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})};