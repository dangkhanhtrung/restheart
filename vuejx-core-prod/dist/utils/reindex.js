"use strict";var __awaiter=this&&this.__awaiter||function(i,s,o,u){return new(o=o||Promise)(function(e,t){function a(e){try{n(u.next(e))}catch(e){t(e)}}function r(e){try{n(u.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(a,r)}n((u=u.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(a,r){var n,i,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=r.call(a,o)}catch(e){t=[6,e],i=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__asyncValues=this&&this.__asyncValues||function(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,t=n[Symbol.asyncIterator];return t?t.call(n):(n="function"==typeof __values?__values(n):n[Symbol.iterator](),e={},a("next"),a("throw"),a("return"),e[Symbol.asyncIterator]=function(){return this},e);function a(r){e[r]=n[r]&&function(a){return new Promise(function(e,t){(function(t,e,a,r){Promise.resolve(r).then(function(e){t({value:e,done:a})},e)})(e,t,(a=n[r](a)).done,a.value)})}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var elasticsearch_1=require("../boostrap/elasticsearch"),oai_pmh_1=require("oai-pmh"),constant_1=require("../constant");function sleep(a){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){for(t=(new Date).getTime();t+a>=(new Date).getTime(););return[2]})})}function TrimEnd(t,a){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){for(;t.endsWith(a)&&""!==t&&""!==a;)t=t.slice(0,-1);return[2,t]})})}function TrimStart(t,a){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){for(;t.startsWith(a)&&""!==t&&""!==a;)t=t.slice(1);return[2,t]})})}exports.reindex=function(p,b,e,v){return __awaiter(_this,void 0,void 0,function(){var t,a,r,n,i,s,o,u,c,d,l,_,f,h,m;return __generator(this,function(e){switch(e.label){case 0:t=p,0<String(p).indexOf("?")&&(t=String(p).substring(0,String(p).indexOf("?"))),a=t.split("/"),a[0],r=a[1],n=a[2],a[3],i=""!==v&&void 0!==v?"&from="+new Date(parseInt(v)):"",s=new oai_pmh_1.OaiPmh("http://localhost:3000/oai/secure?verb=ListRecords&metadataPrefix="+r+"&set="+n+i),o=s.listRecords({metadataPrefix:r}),u=[],e.label=1;case 1:e.trys.push([1,6,7,12]),c=__asyncValues(o),e.label=2;case 2:return[4,c.next()];case 3:if((d=e.sent()).done)return[3,5];if(void 0!==(l=d.value)){for(_ in u.push({index:{_index:r+"___"+n,_type:constant_1._TYPE,_id:l.metadata[n]._id}}),delete l.metadata[n].$,l.metadata[n].id=l.metadata[n]._id,delete l.metadata[n]._id,l.metadata[n])"string"==typeof l.metadata[n][_]?(l.metadata[n][_]=l.metadata[n][_].replace(/^<\!\[CDATA\[|\]\]>$/g,""),isNaN(l.metadata[n][_])?"true"!==l.metadata[n][_]&&"false"!==l.metadata[n][_]||(l.metadata[n][_]="true"===l.metadata[n][_]):l.metadata[n][_]=parseInt(l.metadata[n][_])):"object"==typeof l.metadata[n][_]&&(l.metadata[n][_]=l.metadata[n][_]);u.push(l.metadata[n])}e.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return f=e.sent(),h={error:f},[3,12];case 7:return e.trys.push([7,,10,11]),d&&!d.done&&(m=c.return)?[4,m.call(c)]:[3,9];case 8:e.sent(),e.label=9;case 9:return[3,11];case 10:if(h)throw h.error;return[7];case 11:return[7];case 12:return 0<u.length&&elasticsearch_1.bulkDocument(b,u),[2]}})})},exports.reindexStartUp=function(i,s,o,u){return __awaiter(_this,void 0,void 0,function(){var t,a,r,n;return __generator(this,function(e){switch(e.label){case 0:return t=i,0<String(i).indexOf("?")&&(t=String(i).substring(0,String(i).indexOf("?"))),a=t.split("/"),a[0],r=a[1],n=a[2],a[3],[4,elasticsearch_1.reNewIndex(s,r+"___"+n)];case 1:return e.sent(),[4,exports.reindex(i,s,o,u)];case 2:return e.sent(),[2]}})})},exports.reindexAPI=function(x,S,e){return __awaiter(_this,void 0,void 0,function(){var t,a,r,n,i,s,o,u,c,d,l,_,f,h,m,p,b,v,y,w,g;return __generator(this,function(e){switch(e.label){case 0:for(t=/[?&]([^=#]+)=([^&#]*)/g,a={},r={};r=t.exec("&"+String(x).substring(String(x).indexOf("?")+1));)a[r[1]]=decodeURIComponent(r[2]);return n=x,0<String(x).indexOf("?")&&(n=String(x).substring(0,String(x).indexOf("?"))),i=n.split("/"),i[0],s=i[1],o=i[2],i[3],a.type?(a.from="",a.until="",[4,elasticsearch_1.reNewIndex(S,s+"___"+o)]):[3,2];case 1:e.sent(),e.label=2;case 2:u=a.from,c=a.until,d=""!==u&&void 0!==u?"&from="+new Date(parseInt(u)):"",l=""!==c&&void 0!==c?"&until="+new Date(parseInt(c)):"",_=new oai_pmh_1.OaiPmh("http://localhost:3000/oai/secure?verb=ListRecords&metadataPrefix="+s+"&set="+o+d+l),f=_.listRecords({metadataPrefix:s}),h=[],e.label=3;case 3:e.trys.push([3,8,9,14]),m=__asyncValues(f),e.label=4;case 4:return[4,m.next()];case 5:if((p=e.sent()).done)return[3,7];if(void 0!==(b=p.value)){for(v in h.push({index:{_index:s+"___"+o,_type:constant_1._TYPE,_id:b.metadata[o]._id}}),delete b.metadata[o].$,b.metadata[o].id=b.metadata[o]._id,delete b.metadata[o]._id,b.metadata[o])"string"==typeof b.metadata[o][v]?(b.metadata[o][v]=b.metadata[o][v].replace(/^<\!\[CDATA\[|\]\]>$/g,""),isNaN(b.metadata[o][v])?"true"!==b.metadata[o][v]&&"false"!==b.metadata[o][v]||(b.metadata[o][v]="true"===b.metadata[o][v]):b.metadata[o][v]=parseInt(b.metadata[o][v])):"object"==typeof b.metadata[o][v]&&(b.metadata[o][v]=b.metadata[o][v]);h.push(b.metadata[o])}e.label=6;case 6:return[3,4];case 7:return[3,14];case 8:return y=e.sent(),w={error:y},[3,14];case 9:return e.trys.push([9,,12,13]),p&&!p.done&&(g=m.return)?[4,g.call(m)]:[3,11];case 10:e.sent(),e.label=11;case 11:return[3,13];case 12:if(w)throw w.error;return[7];case 13:return[7];case 14:return 0<h.length&&elasticsearch_1.bulkDocument(S,h),[2]}})})};