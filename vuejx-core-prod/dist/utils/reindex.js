"use strict";var __awaiter=this&&this.__awaiter||function(s,o,i,u){return new(i=i||Promise)(function(e,t){function a(e){try{n(u.next(e))}catch(e){t(e)}}function r(e){try{n(u.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new i(function(e){e(t.value)}).then(a,r)}n((u=u.apply(s,o||[])).next())})},__generator=this&&this.__generator||function(a,r){var n,s,o,e,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,s&&(o=2&t[0]?s.return:t[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,t[1])).done)return o;switch(s=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return i.label++,{value:t[1],done:!1};case 5:i.label++,s=t[1],t=[0];continue;case 7:t=i.ops.pop(),i.trys.pop();continue;default:if(!(o=0<(o=i.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){i=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){i.label=t[1];break}if(6===t[0]&&i.label<o[1]){i.label=o[1],o=t;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(t);break}o[2]&&i.ops.pop(),i.trys.pop();continue}t=r.call(a,i)}catch(e){t=[6,e],s=0}finally{n=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__asyncValues=this&&this.__asyncValues||function(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,t=n[Symbol.asyncIterator];return t?t.call(n):(n="function"==typeof __values?__values(n):n[Symbol.iterator](),e={},a("next"),a("throw"),a("return"),e[Symbol.asyncIterator]=function(){return this},e);function a(r){e[r]=n[r]&&function(a){return new Promise(function(e,t){(function(t,e,a,r){Promise.resolve(r).then(function(e){t({value:e,done:a})},e)})(e,t,(a=n[r](a)).done,a.value)})}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var elasticsearch_1=require("../boostrap/elasticsearch"),oai_pmh_1=require("oai-pmh"),constant_1=require("../constant");exports.reindexStartUpGraphql=function(t,a,r,e,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,exports.reindexAPIGraphql(t,a,r,null,null,"true")];case 1:return e.sent(),[2]}})})},exports.reindexAPIGraphql=function(v,x,g,I,P,S){return __awaiter(_this,void 0,void 0,function(){var t,a,r,n,s,o,i,u,c,l,d,_,f,h,m,p,y,b,w;return __generator(this,function(e){switch(e.label){case 0:return v=v.toLowerCase(),x=x.toLowerCase(),"true"!==S?[3,2]:(P=I="",[4,elasticsearch_1.reNewIndex(g,v+"___"+x)]);case 1:e.sent(),e.label=2;case 2:t=P,a=""!==I&&void 0!==I?"&from="+new Date(parseInt(I)):"",r=""!==t&&void 0!==t?"&until="+new Date(parseInt(t)):"",n=new oai_pmh_1.OaiPmh("http://localhost:3000/oai/secure?verb=ListRecords&metadataPrefix="+v+"&set="+x+a+r),s=n.listRecords({metadataPrefix:v}),o=[],i=0,e.label=3;case 3:e.trys.push([3,9,10,15]),u=__asyncValues(s),e.label=4;case 4:return[4,u.next()];case 5:if((c=e.sent()).done)return[3,8];if(void 0===(l=c.value))return[3,7];for(_ in i+=1,d=l.metadata[x]._id,o.push({index:{_index:v+"___"+x,_type:constant_1._TYPE,_id:d}}),delete l.metadata[x].$,l.metadata[x].id=l.metadata[x]._id,delete l.metadata[x]._id,l.metadata[x])if("string"==typeof l.metadata[x][_])l.metadata[x][_]=l.metadata[x][_].replace(/^<\!\[CDATA\[|\]\]>$/g,""),isNaN(l.metadata[x][_])?"true"!==l.metadata[x][_]&&"false"!==l.metadata[x][_]||(l.metadata[x][_]="true"===l.metadata[x][_]):l.metadata[x][_]="shortName"===_?l.metadata[x][_]:parseInt(l.metadata[x][_]);else if("object"==typeof l.metadata[x][_]){if(Array.isArray(l.metadata[x][_]))for(f=0,h=l.metadata[x][_];f<h.length;f++)for(p in(m=h[f])._source)("string"==typeof m._source[p]&&m._source[p].trim().startsWith("{")&&m._source[p].trim().endsWith("}")||m._source[p].trim().startsWith("[")&&m._source[p].trim().endsWith("]"))&&(m._source[p]=JSON.parse(m._source[p]));l.metadata[x][_]=l.metadata[x][_]}else l.metadata[x][_]=l.metadata[x][_];return o.push(l.metadata[x]),1e4<i?[4,elasticsearch_1.bulkDocument(g,o)]:[3,7];case 6:e.sent(),o=[],e.label=7;case 7:return[3,4];case 8:return[3,15];case 9:return y=e.sent(),b={error:y},[3,15];case 10:return e.trys.push([10,,13,14]),c&&!c.done&&(w=u.return)?[4,w.call(u)]:[3,12];case 11:e.sent(),e.label=12;case 12:return[3,14];case 13:if(b)throw b.error;return[7];case 14:return[7];case 15:return 0<o.length?[4,elasticsearch_1.bulkDocument(g,o)]:[3,17];case 16:e.sent(),e.label=17;case 17:return[2]}})})};