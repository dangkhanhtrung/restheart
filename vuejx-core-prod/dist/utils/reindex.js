"use strict";var __awaiter=this&&this.__awaiter||function(s,o,i,u){return new(i=i||Promise)(function(e,t){function a(e){try{n(u.next(e))}catch(e){t(e)}}function r(e){try{n(u.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new i(function(e){e(t.value)}).then(a,r)}n((u=u.apply(s,o||[])).next())})},__generator=this&&this.__generator||function(a,r){var n,s,o,e,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,s&&(o=2&t[0]?s.return:t[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,t[1])).done)return o;switch(s=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return i.label++,{value:t[1],done:!1};case 5:i.label++,s=t[1],t=[0];continue;case 7:t=i.ops.pop(),i.trys.pop();continue;default:if(!(o=0<(o=i.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){i=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){i.label=t[1];break}if(6===t[0]&&i.label<o[1]){i.label=o[1],o=t;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(t);break}o[2]&&i.ops.pop(),i.trys.pop();continue}t=r.call(a,i)}catch(e){t=[6,e],s=0}finally{n=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__asyncValues=this&&this.__asyncValues||function(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,t=n[Symbol.asyncIterator];return t?t.call(n):(n="function"==typeof __values?__values(n):n[Symbol.iterator](),e={},a("next"),a("throw"),a("return"),e[Symbol.asyncIterator]=function(){return this},e);function a(r){e[r]=n[r]&&function(a){return new Promise(function(e,t){(function(t,e,a,r){Promise.resolve(r).then(function(e){t({value:e,done:a})},e)})(e,t,(a=n[r](a)).done,a.value)})}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var elasticsearch_1=require("../boostrap/elasticsearch"),oai_pmh_1=require("oai-pmh"),constant_1=require("../constant");exports.reindexStartUpGraphql=function(t,a,r,e,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,exports.reindexAPIGraphql(t,a,r,null,null,"true")];case 1:return e.sent(),[2]}})})},exports.reindexAPIGraphql=function(b,v,w,x,g,I){return __awaiter(_this,void 0,void 0,function(){var t,a,r,n,s,o,i,u,c,l,d,_,h,f,m,p,y;return __generator(this,function(e){switch(e.label){case 0:return"true"!==I?[3,2]:(g=x="",[4,elasticsearch_1.reNewIndex(w,b+"___"+v)]);case 1:e.sent(),e.label=2;case 2:t=g,a=""!==x&&void 0!==x?"&from="+new Date(parseInt(x)):"",r=""!==t&&void 0!==t?"&until="+new Date(parseInt(t)):"",n=new oai_pmh_1.OaiPmh("http://localhost:3000/oai/secure?verb=ListRecords&metadataPrefix="+b+"&set="+v+a+r),s=n.listRecords({metadataPrefix:b}),o=[],e.label=3;case 3:e.trys.push([3,9,10,15]),i=__asyncValues(s),e.label=4;case 4:return[4,i.next()];case 5:if((u=e.sent()).done)return[3,8];if(void 0===(c=u.value))return[3,7];for(l in o.push({index:{_index:b+"___"+v,_type:constant_1._TYPE,_id:c.metadata[v]._id}}),delete c.metadata[v].$,c.metadata[v].id=c.metadata[v]._id,delete c.metadata[v]._id,c.metadata[v])if("string"==typeof c.metadata[v][l])c.metadata[v][l]=c.metadata[v][l].replace(/^<\!\[CDATA\[|\]\]>$/g,""),isNaN(c.metadata[v][l])?"true"!==c.metadata[v][l]&&"false"!==c.metadata[v][l]||(c.metadata[v][l]="true"===c.metadata[v][l]):c.metadata[v][l]="shortName"===l?c.metadata[v][l]:parseInt(c.metadata[v][l]);else if("object"==typeof c.metadata[v][l]){if(Array.isArray(c.metadata[v][l]))for(d=0,_=c.metadata[v][l];d<_.length;d++)for(f in(h=_[d])._source)("string"==typeof h._source[f]&&h._source[f].trim().startsWith("{")&&h._source[f].trim().endsWith("}")||h._source[f].trim().startsWith("[")&&h._source[f].trim().endsWith("]"))&&(h._source[f]=JSON.parse(h._source[f]));c.metadata[v][l]=c.metadata[v][l]}return o.push(c.metadata[v]),1e4<o.length?[4,elasticsearch_1.bulkDocument(w,o)]:[3,7];case 6:e.sent(),o=[],e.label=7;case 7:return[3,4];case 8:return[3,15];case 9:return m=e.sent(),p={error:m},[3,15];case 10:return e.trys.push([10,,13,14]),u&&!u.done&&(y=i.return)?[4,y.call(i)]:[3,12];case 11:e.sent(),e.label=12;case 12:return[3,14];case 13:if(p)throw p.error;return[7];case 14:return[7];case 15:return 0<o.length?[4,elasticsearch_1.bulkDocument(w,o)]:[3,17];case 16:e.sent(),e.label=17;case 17:return[2]}})})};