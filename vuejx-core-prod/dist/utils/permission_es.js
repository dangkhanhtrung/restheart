"use strict";var __awaiter=this&&this.__awaiter||function(n,u,a,i){return new(a=a||Promise)(function(e,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,o)}s((i=i.apply(n,u||[])).next())})},__generator=this&&this.__generator||function(r,o){var s,n,u,e,a={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(s)throw new TypeError("Generator is already executing.");for(;a;)try{if(s=1,n&&(u=2&t[0]?n.return:t[0]?n.throw||((u=n.return)&&u.call(n),0):n.next)&&!(u=u.call(n,t[1])).done)return u;switch(n=0,u&&(t=[2&t[0],u.value]),t[0]){case 0:case 1:u=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,n=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(u=0<(u=a.trys).length&&u[u.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!u||t[1]>u[0]&&t[1]<u[3])){a.label=t[1];break}if(6===t[0]&&a.label<u[1]){a.label=u[1],u=t;break}if(u&&a.label<u[2]){a.label=u[2],a.ops.push(t);break}u[2]&&a.ops.pop(),a.trys.pop();continue}t=o.call(r,a)}catch(e){t=[6,e],n=0}finally{s=u=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var arrays_1=require("./arrays"),config_1=require("../config"),httpRequest_1=require("../api/httpRequest"),elasticsearch_1=require("../boostrap/elasticsearch"),token_1=require("./token"),config_2=require("../config"),msg403={message:"Access denied!",error:{statusCode:403,status:403,code:403,message:"Access denied!",name:"permission_denied"}},msg409={message:"Conflict data!",error:{statusCode:409,status:409,code:409,message:"Conflict data!",name:"conflict_data"}};exports.deleteResourceCollection=function(o,e,t,s){return __awaiter(_this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,(t=new httpRequest_1.default(config_1.PROJECT_SERVICE_HOST)).fetch_rest(o+"/"+s.storeDb+"/"+s.shortName+"?pagesize=0",{})];case 1:return r=e.sent(),[4,t.delete_rest(o+"/"+s.storeDb+"/"+s.shortName,{headers:{"If-Match":r.headers.etag}})];case 2:return 204===e.sent().status?[2,null]:[2,msg409]}})})},exports.permissionES=function(i,l,c,h,_){return __awaiter(_this,void 0,void 0,function(){var t,r,o,s,n,u,a;return __generator(this,function(e){switch(e.label){case 0:return t=new httpRequest_1.default(config_1.PROJECT_SERVICE_HOST),r=c,0<String(c).indexOf("?")&&(r=String(c).substring(0,String(c).indexOf("?"))),o=r.split("/"),o[0],s=o[1],n=o[2],o[3],(u="vuejx_cfg"===s)?[4,arrays_1.found(l.role,["admin"])]:[3,2];case 1:u=e.sent(),e.label=2;case 2:return u?"vuejx_db"!==n?[3,4]:[4,t.put_rest(i+"/"+h.request.body.shortName,{})]:[3,11];case 3:return 201===(a=e.sent()).status||200===a.status?[2,null]:[2,msg409];case 4:return"vuejx_collection"!==n?[3,9]:"DELETE"!==h.method?[3,6]:[4,exports.deleteResourceCollection(i,s,n,h.query)];case 5:return null!==e.sent()?[2,msg409]:[3,8];case 6:return void 0===h.request.body.storeDb||""===h.request.body.storeDb||null===h.request.body.storeDb?[3,8]:[4,t.put_rest(i+"/"+h.request.body.storeDb+"/"+h.request.body.shortName,{})];case 7:return 201===(a=e.sent()).status||200===a.status?(elasticsearch_1.createIndex(_,h.request.body.storeDb+"___"+h.request.body.shortName),[2,null]):[2,msg409];case 8:case 9:return[2,null];case 10:return[3,12];case 11:return[2,null];case 12:return[2]}})})},exports.permissionQuery=function(i,l){return __awaiter(_this,void 0,void 0,function(){var t,r,o,s,n,u,a;return __generator(this,function(e){for({},i=null==i||""===i?{username:"guest",roles:["guest"]}:JSON.parse(i),t=/[?&]([^=#]+)=([^&#]*)/g,r={},o={};o=t.exec("&"+l.substring(l.indexOf("?")+1));)r[o[1]]=decodeURIComponent(o[2]);if(r.hasOwnProperty("filter")){for(r.filter=JSON.parse(r.filter),s=[{roleRead:{$exists:!1}}],n=0,u=i.role;n<u.length;n++)a=u[n],s.push({roleRead:a});r.filter.hasOwnProperty("$and")?r.filter.$and.push({$or:s}):r.filter.$or=s}return[2,r]})})},exports.permissionQueryES=function(a,i){return __awaiter(_this,void 0,void 0,function(){var t,r,o,s,n,u;return __generator(this,function(e){switch(e.label){case 0:return t=null,"string"!=typeof i?[3,2]:[4,token_1.verify(i)];case 1:return t=e.sent(),[3,3];case 2:t=i,e.label=3;case 3:return t.hasOwnProperty("tokenExpired")&&t.tokenExpired,r={bool:{should:[]}},""!==i?[3,4]:(void 0!==a.query?void 0!==a.query.bool&&void 0===a.query.bool.must?a.query.bool.must=[r]:void 0!==a.query.bool&&void 0!==a.query.bool.must?a.query.bool.must.push(r):a.query.bool={must:[r]}:a.query={bool:{must:[r]}},[3,7]);case 4:return[4,token_1.verify(i)];case 5:return o=e.sent(),[4,arrays_1.found(o.role,["admin"])];case 6:if(e.sent())r.bool.should=[];else for(s=0,n=o.role;s<n.length;s++)u=n[s],r.bool.should.push({match:{"roleRead._source.shortName":u}});void 0!==a.query?void 0!==a.query.bool&&void 0===a.query.bool.must?a.query.bool.must=[r]:void 0!==a.query.bool&&void 0!==a.query.bool.must?a.query.bool.must.push(r):a.query.bool={must:[r]}:a.query={bool:{must:[r]}},e.label=7;case 7:return[2,a]}})})};var permissionWriteCollection=function(a,i,l){return __awaiter(_this,void 0,void 0,function(){var t,r,o,s,n,u;return __generator(this,function(e){switch(e.label){case 0:return t=!1,(r={}).query={bool:{must:[{bool:{should:[{bool:{must_not:[{exists:{field:"roleWrite"}}]}},{match:{"roleWrite._source.shortName":"guest"}}]}},{match:{shortName:i}}]}},[4,arrays_1.found(l.role,["admin"])];case 1:if(e.sent())r.query.bool.must[0].bool.should=[];else for(o=0,s=l.role;o<s.length;o++)n=s[o],r.query.bool.must[0].bool.should.push({match:{"roleWrite._source.shortName":n}});return u="/".concat("vuejx_cfg").concat("___").concat("vuejx_collection").concat("/").concat("_search?request_cache=true"),[4,a.search_rest(config_2.esConfig.host+u,r)];case 2:return 0<e.sent().data.hits.total.value&&(t=!0),[2,t]}})})},permissionWriteItem=function(a,i,l,c,h){return __awaiter(_this,void 0,void 0,function(){var t,r,o,s,n,u;return __generator(this,function(e){switch(e.label){case 0:return t=!1,(r={}).query={bool:{must:[{bool:{should:[{bool:{must_not:[{exists:{field:"roleWrite"}}]}},{match:{"roleWrite._source.shortName":"guest"}}]}},{match:{shortName:i}}]}},[4,arrays_1.found(l.role,["admin"])];case 1:if(e.sent())r.query.bool.must[0].bool.should=[];else for(o=0,s=l.role;o<s.length;o++)n=s[o],r.query.bool.must[0].bool.should.push({match:{"roleWrite._source.shortName":n}});return u="/".concat(c).concat("___").concat(h).concat("/").concat("_search?request_cache=true"),[4,a.search_rest(config_2.esConfig.host+u,r)];case 2:return 0<e.sent().data.hits.total.value&&(t=!0),[2,t]}})})};