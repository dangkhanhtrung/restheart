"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("dotenv/config");var compress=require("koa-compress"),koa=require("koa"),helmet=require("koa-helmet"),cors=require("@koa/cors"),config_1=require("./config"),boostrap_1=require("./boostrap"),cluster=require("cluster"),bodyparser=require("koa-bodyparser"),apiRouter_1=require("./routes/apiRouter"),elasticsearch_1=require("./boostrap/elasticsearch"),vuejxcfg_1=require("./boostrap/vuejxcfg"),cpuCount=process.env.CLUSTER_NODE;boostrap_1.bootstrap().then(function(e){if(cluster.isMaster){for(var r=0;r<parseInt(cpuCount);r+=1)cluster.fork();cluster.on("exit",function(e){console.log("Worker %d died :(",e.id),cluster.fork()})}else{var o=new koa,t=config_1.PROJECT_PATH;o.use(bodyparser()),o.use(compress()),o.use(helmet()),o.use(cors()),o.use(apiRouter_1.default.routes()).use(apiRouter_1.default.allowedMethods()),e.applyMiddleware({app:o,path:t}),o.listen({port:config_1.ENV.PORT},function(){vuejxcfg_1.initVueJX(elasticsearch_1.elasticClient),console.log("Server ready at http://"+config_1.host+":"+config_1.port+e.graphqlPath)})}});