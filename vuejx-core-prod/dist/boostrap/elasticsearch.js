"use strict";var __awaiter=this&&this.__awaiter||function(o,c,s,u){return new(s=s||Promise)(function(e,t){function n(e){try{i(u.next(e))}catch(e){t(e)}}function r(e){try{i(u.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,r)}i((u=u.apply(o,c||[])).next())})},__generator=this&&this.__generator||function(n,r){var i,o,c,e,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(c=2&t[0]?o.return:t[0]?o.throw||((c=o.return)&&c.call(o),0):o.next)&&!(c=c.call(o,t[1])).done)return c;switch(o=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){s.label=t[1];break}if(6===t[0]&&s.label<c[1]){s.label=c[1],c=t;break}if(c&&s.label<c[2]){s.label=c[2],s.ops.push(t);break}c[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],o=0}finally{i=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var elasticsearch_1=require("elasticsearch"),config_1=require("../config"),vuejxcfg_1=require("./vuejxcfg");exports.elasticSearchConnection=function(){return new elasticsearch_1.Client(config_1.esConfig)},exports.pingElasticsearch=function(t){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return[2,t.ping({requestTimeout:3e3})]})})},exports.createIndex=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return exports.indexExists(t,n).then(function(e){e||exports.init(t,n)}),[2]})})},exports.initIndex=function(n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return["vuejx_cfg___vuejx_page","vuejx_cfg___vuejx_site","vuejx_cfg___vuejx_db","vuejx_cfg___vuejx_collection","vuejx_cfg___scope","vuejx_cfg___projection","vuejx_cfg___oai_pmh_config","vuejx_cfg___oai_pmh_async","vuejx_cfg____schemas","profilesdatabase___person","directory___role","directory___profile","directory___dict_collection","directory___dict_item","directory___permission","directory___storage","directory___open_access"].forEach(function(t){exports.indexExists(n,t).then(function(e){e||exports.init(n,t),vuejxcfg_1.mappingIndices(n,t)})}),[2]})})},exports.removeIndex=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return exports.indexExists(t,n).then(function(e){e&&t.indices.delete({index:n})}),[2]})})},exports.reNewIndex=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,t.indices.delete({index:n}).catch(function(e){}).finally(function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,exports.init(t,n)];case 1:return e.sent(),[2]}})})})];case 1:return e.sent(),[2]}})})},exports.addIndex=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return exports.indexExists(t,n).then(function(e){e||exports.init(t,n)}),[2]})})},exports.addDocument=function(n,r,i,o,c){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.index({index:r,type:i,id:o,body:c})];case 1:return[2,e.sent()];case 2:return t=e.sent(),console.error(t),[2,void 0];case 3:return[2]}})})},exports.bulkDocument=function(n,r){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.bulk({body:r})];case 1:return[2,e.sent()];case 2:return t=e.sent(),console.error(t),[2,void 0];case 3:return[2]}})})},exports.updateDocument=function(n,r,i,o,c){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.update({index:r,type:i,id:o,body:{doc:c}})];case 1:return[2,e.sent()];case 2:return t=e.sent(),console.error(t),[2,void 0];case 3:return[2]}})})},exports.putMapping=function(client,documentType,body){return __awaiter(_this,void 0,void 0,function(){var raw,config,_i,config_2,field;return __generator(this,function(_a){try{for(raw=eval("( "+body.config+" )"),config=raw.config.form,_i=0,config_2=config;_i<config_2.length;_i++)field=config_2[_i],field.hasOwnProperty("aggs")&&console.log(field)}catch(e){return console.error(e),[2,void 0]}return[2]})})},exports.deleteDocument=function(t,n,r,i){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,t.delete({index:n,type:r,id:String(i)})];case 1:return[2,e.sent()];case 2:return e.sent(),[2,void 0];case 3:return[2]}})})},exports.searchDocument=function(n,r,i,o){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.search({index:r,type:i,body:o})];case 1:return[2,e.sent()];case 2:return t=e.sent(),console.error(t),[2,void 0];case 3:return[2]}})})},exports.elasticClient=exports.elasticSearchConnection(),exports.init=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,t.indices.create({index:n,body:{settings:{index:{number_of_shards:2,number_of_replicas:1,refresh_interval:"1s",max_result_window:config_1.max_result_window}}}})];case 1:return e.sent(),[4,vuejxcfg_1.mappingIndices(t,n)];case 2:return e.sent(),[2]}})})},exports.initClone=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return exports.indexExists(t,n).then(function(e){e||exports.init(t,n)}),[2]})})},exports.indexExists=function(t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,t.indices.exists({index:n})];case 1:return[2,e.sent()]}})})};var initBaseEntity=function(e,t){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})};exports.initBaseUser=function(e,t,n){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})};