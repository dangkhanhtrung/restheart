"use strict";var __awaiter=this&&this.__awaiter||function(o,a,c,s){return new(c=c||Promise)(function(e,t){function n(e){try{i(s.next(e))}catch(e){t(e)}}function r(e){try{i(s.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(n,r)}i((s=s.apply(o,a||[])).next())})},__generator=this&&this.__generator||function(n,r){var i,o,a,e,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,o=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){c.label=t[1];break}if(6===t[0]&&c.label<a[1]){c.label=a[1],a=t;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(t);break}a[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],o=0}finally{i=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var config_1=require("../config"),httpRequest_1=require("../api/httpRequest"),config_2=require("../config"),vuejxcfg_directory_1=require("./vuejxcfg_directory"),vuejxcfg_profilesdatabase_1=require("./vuejxcfg_profilesdatabase"),vuejxcfg_base_1=require("./vuejxcfg_base"),crypto=require("crypto"),config_3=require("../config");exports.mappingIndices=function(elasticClient,indices){return __awaiter(_this,void 0,void 0,function(){var httpReq,_a,db,collection,pullDefaultDB,metadataConfig,confiii,propertiesPut,_i,metadataConfig_1,el;return __generator(this,function(_b){switch(_b.label){case 0:return httpReq=new httpRequest_1.default(config_1.PROJECT_SERVICE_HOST),_a=indices.split("___"),db=_a[0],collection=_a[1],[4,config_3.getClient().db("vuejx_cfg").collection("vuejx_collection").findOne({shortName:collection},{username:1})];case 1:if(pullDefaultDB=_b.sent(),null==pullDefaultDB)return[3,3];for(metadataConfig=[],confiii=pullDefaultDB.metadataConfig,""!==confiii&&void 0!==eval("( "+confiii+" )")&&(metadataConfig=eval("( "+confiii+" )").form),propertiesPut={properties:{}},_i=0,metadataConfig_1=metadataConfig;_i<metadataConfig_1.length;_i++)el=metadataConfig_1[_i],void 0!==el.model&&null!==el.model&&""!==el.model&&"storeDb"!==el.model&&"publicOAI"!==el.model&&"recordStatus"!==el.model&&"type"!==el.model&&"username"!==el.model&&("number"===el.dataType?propertiesPut.properties[el.model]={type:"long"}:"string"===el.dataType?propertiesPut.properties[el.model]={type:"keyword"}:"object"===el.dataType?(propertiesPut.properties[el.model+"._source.shortName"]={type:"keyword"},propertiesPut.properties[el.model+"._source.shortNameRef"]={type:"keyword"},propertiesPut.properties[el.model+"._source.title"]={type:"keyword"}):propertiesPut.properties[el.model]={type:el.dataType});return propertiesPut.properties.storeDb={type:"keyword"},propertiesPut.properties.publicOAI={type:"boolean"},propertiesPut.properties.recordStatus={type:"boolean"},propertiesPut.properties.type={type:"text"},propertiesPut.properties.username={type:"keyword"},[4,httpReq.put_rest(config_2.esConfig.host+"/"+indices+"/_mapping",propertiesPut,{})];case 2:_b.sent(),_b.label=3;case 3:return[2]}})})},exports.initVueJX=function(a){return __awaiter(_this,void 0,void 0,function(){var t,n,r,i,o;return __generator(this,function(e){switch(e.label){case 0:return t=(new Date).getTime(),[4,config_3.getClient().db("vuejx_cfg").createCollection("_schemas")];case 1:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("vuejx_site")];case 2:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("vuejx_page")];case 3:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("vuejx_db")];case 4:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("vuejx_collection")];case 5:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("oai_pmh_config")];case 6:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("oai_pmh_async")];case 7:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("scope")];case 8:return e.sent(),[4,config_3.getClient().db("vuejx_cfg").createCollection("projection")];case 9:return e.sent(),[4,config_3.getClient().db("oauth2").createCollection("users")];case 10:return e.sent(),[4,config_3.getClient().db("oauth2").createCollection("oauthclients")];case 11:return e.sent(),[4,config_3.getClient().db("directory").createCollection("role")];case 12:return e.sent(),[4,config_3.getClient().db("directory").createCollection("permission")];case 13:return e.sent(),[4,config_3.getClient().db("directory").createCollection("open_access")];case 14:return e.sent(),[4,config_3.getClient().db("directory").createCollection("storage")];case 15:return e.sent(),[4,config_3.getClient().db("directory").createCollection("dict_collection")];case 16:return e.sent(),[4,config_3.getClient().db("directory").createCollection("dict_item")];case 17:return e.sent(),[4,config_3.getClient().db("profilesdatabase").createCollection("person")];case 18:e.sent(),(n=config_3.getClient().startSession()).startTransaction(),e.label=19;case 19:return e.trys.push([19,40,,42]),r={session:n,returnOriginal:!1},[4,config_3.getClient().db("vuejx_cfg").collection("vuejx_collection").findOne({shortName:"_schemas"},{username:1})];case 20:return null!=e.sent()?[3,23]:[4,config_3.getClient().db("vuejx_cfg").collection("vuejx_collection").insertOne({type:"vuejx_collection",createdAt:t,modifiedAt:t,shortName:"_schemas",email:"binhth.vuejx@gmail.com",username:"binhth",title:"JSON Schema Validation",order:9999,status:{_source:{shortName:"activate",title:"Activate"}},site:"guest",storage:"regular",openAccess:2,accessRoles:[],accessUsers:[],accessEmails:[],description:"JSON Schema Validation",metadataConfig:"{\n                    type: 0,\n                    form: [\n                        {\n                            model: 'shortName',\n                            dataType: 'keyword',\n                            type: 'text',\n                            class: 'xs12',\n                            label: 'ShortName:'\n                        },\n                        {\n                            model: 'tableConfig',\n                            dataType: 'text',\n                            type: 'codemirror',\n                            class: 'xs12',\n                            label: 'tableConfig:'\n                        },\n                    ]\n                }",tableConfig:"{\n                    title: \"JSON Schema Validation\",\n                    columns: [\"shortName\"],\n                    config_columns: [\n                        {\n                            field: '_source.id',\n                            field_query: 'id',\n                            field_sort: 'id',\n                            headerText: 'ShortName',\n                            textAlign: 'left',\n                            width: 220,\n                            minWidth: 220\n                        }\n                    ],\n                    sort: [\n                        { \"order\": \"asc\" }\n                    ]\n                }"},r)];case 21:return e.sent().insertedCount<=0?[4,n.abortTransaction()]:[3,23];case 22:e.sent(),n.endSession(),e.label=23;case 23:return[4,vuejxcfg_directory_1.initRole(a,n,r)];case 24:return e.sent(),[4,vuejxcfg_directory_1.initPermission(a,n,r)];case 25:return e.sent(),[4,vuejxcfg_directory_1.initOpenAccess(a,n,r)];case 26:return e.sent(),[4,vuejxcfg_directory_1.initMode(a,n,r)];case 27:return e.sent(),[4,vuejxcfg_directory_1.initDictCollection(a,n,r)];case 28:return e.sent(),[4,vuejxcfg_directory_1.initItem(a,n,r)];case 29:return e.sent(),[4,vuejxcfg_profilesdatabase_1.initPerson(a,n,r)];case 30:return e.sent(),[4,vuejxcfg_base_1.initSite(a,n,r)];case 31:return e.sent(),[4,vuejxcfg_base_1.initPage(a,n,r)];case 32:return e.sent(),[4,vuejxcfg_base_1.initDB(a,n,r)];case 33:return e.sent(),[4,vuejxcfg_base_1.initCollection(a,n,r)];case 34:return e.sent(),[4,vuejxcfg_base_1.initOaiPmhConfig(a,n,r)];case 35:return e.sent(),[4,vuejxcfg_base_1.initOaiPmhAsync(a,n,r)];case 36:return e.sent(),[4,vuejxcfg_base_1.initScope(a,n,r)];case 37:return e.sent(),[4,vuejxcfg_base_1.initProjection(a,n,r)];case 38:return e.sent(),[4,n.commitTransaction()];case 39:return e.sent(),n.endSession(),[3,42];case 40:return i=e.sent(),console.error(i),[4,n.abortTransaction()];case 41:return e.sent(),n.endSession(),[3,42];case 42:return new httpRequest_1.default(config_1.PROJECT_SERVICE_HOST),[4,config_3.getClient().db("oauth2").collection("users").findOne({username:"admin"})];case 43:return null!=(o=e.sent())?[3,45]:[4,config_3.getClient().db("oauth2").collection("users").insertOne({username:"admin",password:crypto.createHash("sha256").update("admin").digest("hex"),scope:"admin",roles:["admin"]})];case 44:e.sent(),e.label=45;case 45:return[4,config_3.getClient().db("oauth2").collection("oauthclients").findOne({name:"admin"})];case 46:return null!=e.sent()?[3,48]:null==o?[3,48]:[4,config_3.getClient().db("oauth2").collection("oauthclients").insertOne({name:"admin",clientId:crypto.createHash("md5").update(crypto.randomBytes(16)).digest("hex"),clientSecret:crypto.createHash("sha256").update(crypto.randomBytes(32)).digest("hex"),redirectUris:["/oauth/callback"],grants:["authorization_code","password","refresh_token"],scope:"admin",user:o._id})];case 47:e.sent(),e.label=48;case 48:return e.trys.push([48,50,,51]),[4,config_3.getClient().db("oauth2").addUser("oauth2_user","123456Aa",{roles:[{role:"dbAdmin",db:"oauth2"},{role:"dbOwner",db:"oauth2"},{role:"enableSharding",db:"oauth2"},{role:"userAdmin",db:"oauth2"},{role:"read",db:"oauth2"},{role:"readWrite",db:"oauth2"}]})];case 49:return e.sent(),[3,51];case 50:return e.sent(),[3,51];case 51:return[2]}})})};