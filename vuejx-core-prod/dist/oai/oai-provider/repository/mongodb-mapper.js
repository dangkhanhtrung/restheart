"use strict";var __awaiter=this&&this.__awaiter||function(n,i,s,c){return new(s=s||Promise)(function(e,r){function t(e){try{o(c.next(e))}catch(e){r(e)}}function a(e){try{o(c.throw(e))}catch(e){r(e)}}function o(r){r.done?e(r.value):new s(function(e){e(r.value)}).then(t,a)}o((c=c.apply(n,i||[])).next())})},__generator=this&&this.__generator||function(t,a){var o,n,i,e,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,n&&(i=2&r[0]?n.return:r[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,r[1])).done)return i;switch(n=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,n=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){s.label=r[1];break}if(6===r[0]&&s.label<i[1]){s.label=i[1],i=r;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(r);break}i[2]&&s.ops.pop(),s.trys.pop();continue}r=a.call(t,s)}catch(e){r=[6,e],n=0}finally{o=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}},__asyncValues=this&&this.__asyncValues||function(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,r=o[Symbol.asyncIterator];return r?r.call(o):(o="function"==typeof __values?__values(o):o[Symbol.iterator](),e={},t("next"),t("throw"),t("return"),e[Symbol.asyncIterator]=function(){return this},e);function t(a){e[a]=o[a]&&function(t){return new Promise(function(e,r){(function(r,e,t,a){Promise.resolve(a).then(function(e){r({value:e,done:t})},e)})(e,r,(t=o[a](t)).done,t.value)})}}};Object.defineProperty(exports,"__esModule",{value:!0});var api_1=require("../../../api"),config_1=require("../../../config"),jsonMapper=require("json-mapper-json"),MongodbDcMapper=function(){function MongodbDcMapper(){}return MongodbDcMapper.prototype.setTimeZoneOffset=function(e){var r=new Date;return r="object"==typeof e.modifiedAt?void 0!==e.modifiedAt?new Date(parseInt(e.modifiedAt.$numberLong)):new Date:void 0!==e.modifiedAt?new Date(parseInt(e.modifiedAt)):new Date,new Date(r.getTime()+-6e4*r.getTimezoneOffset()).toISOString().split(".")[0]+"Z"},MongodbDcMapper.prototype.createItemRecord=function(m,e){var r=this.setTimeZoneOffset(m),v=[];v.push({_attr:{"xmlns:oai_dc":"http://www.openarchives.org/OAI/2.0/oai_dc/","xmlns:dc":"http://purl.org/dc/elements/1.1/","xmlns:xsi":"http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation":"http://www.openarchives.org/OAI/2.0/oai_dc/ http://www.openarchives.org/OAI/2.0/oai_dc.xsd"}});var t=e;0<e.indexOf("?")&&(t=e.substring(0,e.indexOf("?")));function a(n){var e={};if("object"==typeof m[n]&&"_id"!==n){if(Array.isArray(m[n])&&void 0!==m[n]&&null!==m[n]){for(var r in m[n])if("string"!=typeof m[n][r])if(null!==m[n][r]&&m[n][r].hasOwnProperty("_source")){var t=[];for(var a in m[n][r]){m[n][r][a];var o=[];for(var i in m[n][r][a]){var s;if("shortName"===i||"shortNameRef"===i||"title"===i||"type"===i)(s={})[i]=m[n][r][a][i],o.push(s);else(s={})[i]=JSON.stringify(m[n][r][a][i]),o.push(s)}t.push({_source:o})}(c={})[n]=t,v.push(c)}else{var c={};for(var a in c[n]=[],m[n][r])if("object"==typeof m[n][r][a]&&null!==m[n][r][a]){var u={};for(var d in u[a]=[],m[n][r][a])if("object"==typeof m[n][r][a][d])for(var p in m[n][r][a][d])if("shortName"===p||"shortNameRef"===p||"title"===p||"type"===p){var f={};f[p]=m[n][r][a][d][p],u[a].push(f)}c[n].push(u)}else{var _={};_[a]=m[n][r][a],c[n].push(_)}v.push(c)}}else if(!Array.isArray(m[n])&&"object"==typeof m[n]&&n.toLowerCase().endsWith("config"))e[n]="<![CDATA["+JSON.stringify(m[n],null,"\t")+"]]>",v.push(e);else if(!Array.isArray(m[n])&&"object"==typeof m[n]){var l=[];if(m[n].hasOwnProperty("_source")){var h={_source:[]};h._source.push({shortName:m[n]._source.shortName}),h._source.push({shortNameRef:m[n]._source.shortNameRef}),h._source.push({title:m[n]._source.title}),h._source.push({type:m[n]._source.type}),l.push(h),e[n]=l,v.push(e)}else 0<=String(m[n]).indexOf("{")?(Object.keys(m[n]).forEach(function(e){var r={};if(Array.isArray(m[n][e]))if(0===m[n][e].length)r[e]=[],l.push(r);else for(var t=0,a=m[n][e];t<a.length;t++){var o=a[t];(r={})[e]=o,l.push(r)}else r[e]=[],l.push(r)}),e[n]=l):e[n]=m[n],v.push(e)}}else"_id"!==n?"string"==typeof m[n]&&(0<m[n].indexOf("<")||0<m[n].indexOf(">")||0<m[n].indexOf("&")||0<m[n].indexOf("'")||0<m[n].indexOf('"'))?e[n]="<![CDATA["+m[n]+"]]>":"$schema"===n?e._schema=m[n]:e[n]=m[n]:e[n]=String(m[n]),v.push(e)}for(var o in m)a(o);var n=[],i={};i[t]=v,n.push(i);var s=void 0!==m._id.$oid&&null!==m._id.$oid?m._id.$oid:m._id;return{record:[{header:[{identifier:"oai:"+config_1.STORE+":"+m.type+"/"+s},{datestamp:r}]},{metadata:n}]}},MongodbDcMapper.prototype.mapOaiDcListRecords=function(e){},MongodbDcMapper.prototype.mapOaiDcGetRecord=function(e){var r=e.pop();if(!r)throw new Error("Record not found");return this.createItemRecord(r,"set")},MongodbDcMapper.prototype.mapOaiDcListIdentifiers=function(e){for(var r=[],t={ListIdentifiers:[]},a=0,o=e;a<o.length;a++){var n=o[a],i=this.setTimeZoneOffset(n),s={record:[{header:[{identifier:"oai:"+config_1.STORE+":"+n.type+"/"+n.id.toString()},{datestamp:i}]}]};r.push(s)}return t.ListIdentifiers=r,t},MongodbDcMapper.prototype.mapGetRecord=function(n){return __awaiter(this,void 0,void 0,function(){var r,t,a,o;return __generator(this,function(e){switch(e.label){case 0:return r=[],t={GetRecord:[]},void 0===n.identifier||null===n.identifier||""===n.identifier||void 0===n.metadataPrefix||null===n.metadataPrefix||""===n.metadataPrefix||void 0===n.set||null===n.set||""===n.set?[3,2]:[4,api_1.vuejxService.oaiGetDetail(n)];case 1:return null!==(a=e.sent())&&(o=this.createItemRecord(a,n.set),r.push(o)),t.GetRecord=r,[2,t];case 2:return[2,null]}})})},MongodbDcMapper.prototype.mapListRecords=function(d){return __awaiter(this,void 0,void 0,function(){var r,t,a,o,n,i,s,c,u;return __generator(this,function(e){switch(e.label){case 0:return r=[],t={ListRecords:[]},[4,api_1.vuejxService.oaiMongoQuery(d)];case 1:for(a=e.sent(),o=a._size,n=0,i=a._embedded;n<i.length;n++)s=i[n],c=this.createItemRecord(s,d.query.set),r.push(c);return(u=a.resumptionToken+1)<=Math.floor(o/config_1.PAGESIZE)?r.push({resumptionToken:[{_attr:{completeListSize:o}},u]}):delete t.resumptionToken,t.ListRecords=r,[2,t]}})})},MongodbDcMapper.prototype.mapListRecordsAsync=function(d){return __awaiter(this,void 0,void 0,function(){var r,t,a,o,n,i,s,c,u;return __generator(this,function(e){switch(e.label){case 0:return r=[],t={ListRecords:[],resumptionToken:[]},[4,api_1.vuejxService.asyncMongoOAI(d)];case 1:for(a=e.sent(),o=a._size,n=0,i=a._embedded;n<i.length;n++)s=i[n],c=this.createItemRecord(s,d.query.set),r.push(c);return(u=a.resumptionToken+1)<=Math.floor(o/config_1.PAGESIZE)?t.resumptionToken=[{_attr:{completeListSize:o}},u]:delete t.resumptionToken,t.ListRecords=r,[2,t]}})})},MongodbDcMapper.prototype.mapIdentify=function(user,metadataPrefix,set){return __awaiter(this,void 0,void 0,function(){var response,record,item;return __generator(this,function(_a){switch(_a.label){case 0:return response={Identify:[]},[4,api_1.vuejxService.repoExistOAI(user,metadataPrefix,set)];case 1:return record=_a.sent(),item=eval("( "+record.oai_identify_xml+" )"),[4,jsonMapper(record,item).then(function(e){for(var r in e){var t='\n                    {\n                        "'+r+'": "'+e[r]+'"\n                    }\n                ';response.Identify.push(JSON.parse(t))}})];case 2:return _a.sent(),[2,response]}})})},MongodbDcMapper.prototype.mapListMetadataFormats=function(user,metadataPrefix,set){var e_1,_a,e_2,_b;return __awaiter(this,void 0,void 0,function(){var response,record,record_1,record_1_1,element,metadataFormat,arraySchema,formConfig,_c,_d,metadata,e_2_1,e_1_1;return __generator(this,function(_e){switch(_e.label){case 0:return response={ListMetadataFormats:[]},[4,api_1.vuejxService.oaiMetadataFormats(user,metadataPrefix,set)];case 1:record=_e.sent(),_e.label=2;case 2:_e.trys.push([2,19,20,25]),record_1=__asyncValues(record),_e.label=3;case 3:return[4,record_1.next()];case 4:if(record_1_1=_e.sent(),record_1_1.done)return[3,18];if(element=record_1_1.value,metadataFormat=[],void 0===element._source)return[3,17];if(metadataFormat.push({metadataPrefix:element._source.shortName}),arraySchema=[],void 0===element._source.metadataConfig)return[3,17];formConfig=eval("( "+element._source.metadataConfig+" )"),_e.label=5;case 5:_e.trys.push([5,10,11,16]),_c=__asyncValues(formConfig.form),_e.label=6;case 6:return[4,_c.next()];case 7:if(_d=_e.sent(),_d.done)return[3,9];metadata=_d.value,void 0!==metadata.dataType&&"object"!==metadata.dataType&&arraySchema.push({element:{_attr:{name:metadata.model,type:metadata.dataType}}}),_e.label=8;case 8:return[3,6];case 9:return[3,16];case 10:return e_2_1=_e.sent(),e_2={error:e_2_1},[3,16];case 11:return _e.trys.push([11,,14,15]),_d&&!_d.done&&(_b=_c.return)?[4,_b.call(_c)]:[3,13];case 12:_e.sent(),_e.label=13;case 13:return[3,15];case 14:if(e_2)throw e_2.error;return[7];case 15:return[7];case 16:metadataFormat.push({schema:arraySchema}),response.ListMetadataFormats.push({metadataFormat:metadataFormat}),_e.label=17;case 17:return[3,3];case 18:return[3,25];case 19:return e_1_1=_e.sent(),e_1={error:e_1_1},[3,25];case 20:return _e.trys.push([20,,23,24]),record_1_1&&!record_1_1.done&&(_a=record_1.return)?[4,_a.call(record_1)]:[3,22];case 21:_e.sent(),_e.label=22;case 22:return[3,24];case 23:if(e_1)throw e_1.error;return[7];case 24:return[7];case 25:return[2,response]}})})},MongodbDcMapper}();exports.MongodbDcMapper=MongodbDcMapper;