"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var HARVESTING_GRANULARITY,DELETED_RECORDS_SUPPORT,ERRORS,METADATA_FORMAT_DC,VERBS,EXCEPTION_CODES,oai_response_1=require("./oai-response"),oai_service_1=require("./oai-service");!function(e){e.DATE="YYYY-MM-DD",e.DATETIME="YYYY-MM-DDThh:mm:ssZ"}(HARVESTING_GRANULARITY=exports.HARVESTING_GRANULARITY||(exports.HARVESTING_GRANULARITY={})),function(e){e.NO="no",e.TRANSIENT="transient",e.PERSISTENT="persistent"}(DELETED_RECORDS_SUPPORT=exports.DELETED_RECORDS_SUPPORT||(exports.DELETED_RECORDS_SUPPORT={})),function(e){e[e.badArgument=0]="badArgument",e[e.badResumptionToken=1]="badResumptionToken",e[e.badVerb=2]="badVerb",e[e.cannotDisseminateFormat=4]="cannotDisseminateFormat",e[e.idDoesNotExist=8]="idDoesNotExist",e[e.noRecordsMatch=16]="noRecordsMatch",e[e.noMetadataFormats=32]="noMetadataFormats",e[e.noSetHierarchy=64]="noSetHierarchy"}(ERRORS=exports.ERRORS||(exports.ERRORS={})),function(e){e.prefix="oai_dc",e.schema="http://www.openarchives.org/OAI/2.0/oai_dc.xsd",e.namespace="http://www.openarchives.org/OAI/2.0/oai_dc/"}(METADATA_FORMAT_DC=exports.METADATA_FORMAT_DC||(exports.METADATA_FORMAT_DC={})),function(e){e.IDENTIFY="Identify",e.LIST_METADATA_FORMATS="ListMetadataFormats",e.LIST_SETS="ListSets",e.GET_RECORD="GetRecord",e.LIST_IDENTIFIERS="ListIdentifiers",e.LIST_RECORDS="ListRecords"}(VERBS=exports.VERBS||(exports.VERBS={})),function(e){e.BAD_ARGUMENT="badArgument",e.BAD_RESUMPTION_TOKEN="badResumptionToken",e.BAD_VERB="badVerb",e.CANNOT_DISSEMINATE_FORMAT="cannotDisseminateFormat",e.ID_DOES_NOT_EXIST="idDoesNotExist",e.NO_RECORDS_MATCH="noRecordsMatch",e.NO_METADATA_FORMATS="noMetadataFormats",e.NO_SET_HIERARCHY="noSetHierarchy"}(EXCEPTION_CODES=exports.EXCEPTION_CODES||(exports.EXCEPTION_CODES={}));var CoreOaiProvider=function(){function e(e,t,r){this.possibleParams=["verb","from","until","metadataPrefix","set","resumptionToken"],this.oaiService=new oai_service_1.OaiService(e,t),this.parameters=this.oaiService.getParameters(),this.mapper=r}return e.prototype.listMetadataFormats=function(i){var n=this;return new Promise(function(r,a){var e=n.getQueryParameters(i),o={baseUrl:n.parameters.baseURL,verb:VERBS.LIST_METADATA_FORMATS,metadataPrefix:METADATA_FORMAT_DC.prefix};if(2<e.length||2===e.length&&!n.hasKey(i,"identifier"))r(oai_response_1.generateException(o,EXCEPTION_CODES.BAD_ARGUMENT));else{var t=n.hasKey(i,"identifier")?i.identifier:void 0;n.oaiService.getProvider().getMetadataFormats(t).then(function(e){try{var t={ListMetadataFormats:e.map(function(e){return{metadataFormat:[{metadataPrefix:e.prefix},{schema:e.schema},{metadataNamespace:e.namespace}]}})};r(oai_response_1.generateResponse(i,n.parameters.baseURL,t))}catch(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.NO_METADATA_FORMATS))}})}})},e.prototype.getRecord=function(i){var n=this;return new Promise(function(r,a){var e=n.getQueryParameters(i),o={baseUrl:n.parameters.baseURL,verb:VERBS.GET_RECORD,identifier:i.identifier,metadataPrefix:METADATA_FORMAT_DC.prefix};3===e.length&&n.hasKey(i,"identifier")&&n.hasKey(i,"metadataPrefix")?n.oaiService.getProvider().getRecord(i).then(function(e){try{if(1===e.length){var t=n.mapper.mapOaiDcGetRecord(e);r(oai_response_1.generateResponse(i,n.parameters.baseURL,t))}else r(oai_response_1.generateException(o,EXCEPTION_CODES.ID_DOES_NOT_EXIST))}catch(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.ID_DOES_NOT_EXIST))}}).catch(function(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.ID_DOES_NOT_EXIST))}):r(oai_response_1.generateException(o,EXCEPTION_CODES.BAD_ARGUMENT))})},e.prototype.listIdentifiers=function(i){var n=this;return new Promise(function(r,a){var e=n.getQueryParameters(i),o={baseUrl:n.parameters.baseURL,verb:VERBS.LIST_IDENTIFIERS,metadataPrefix:METADATA_FORMAT_DC.prefix};(6<e.length||e.length<2)&&r(oai_response_1.generateException(o,EXCEPTION_CODES.BAD_ARGUMENT)),n.hasInvalidListParameter(e,i)&&r(oai_response_1.generateException(o,EXCEPTION_CODES.BAD_ARGUMENT)),n.hasKey(i,"set")&&(n.hasSetSupport()||r(oai_response_1.generateException(o,EXCEPTION_CODES.NO_SET_HIERARCHY))),n.oaiService.getProvider().getIdentifiers(i).then(function(e){0===e.length&&r(oai_response_1.generateException(o,EXCEPTION_CODES.NO_RECORDS_MATCH));try{var t=n.mapper.mapOaiDcListIdentifiers(e);r(oai_response_1.generateResponse(i,n.parameters.baseURL,t))}catch(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.NO_RECORDS_MATCH))}}).catch(function(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.NO_RECORDS_MATCH))})})},e.prototype.listRecords=function(i){var n=this;return new Promise(function(r,a){var e=n.getQueryParameters(i),o={baseUrl:n.parameters.baseURL,verb:VERBS.LIST_RECORDS,metadataPrefix:METADATA_FORMAT_DC.prefix};(6<e.length||e.length<2)&&r(oai_response_1.generateException(o,EXCEPTION_CODES.BAD_ARGUMENT)),n.hasInvalidListParameter(e,i)&&r(oai_response_1.generateException(o,EXCEPTION_CODES.BAD_ARGUMENT)),n.hasKey(i,"set")&&(n.hasSetSupport()||r(oai_response_1.generateException(o,EXCEPTION_CODES.NO_SET_HIERARCHY))),n.oaiService.getProvider().getRecords(i).then(function(e){0===e.length&&r(oai_response_1.generateException(o,EXCEPTION_CODES.NO_RECORDS_MATCH));try{var t=n.mapper.mapOaiDcListRecords(e);r(oai_response_1.generateResponse(i,n.parameters.baseURL,t))}catch(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.NO_RECORDS_MATCH))}}).catch(function(e){a(oai_response_1.generateException(o,EXCEPTION_CODES.NO_RECORDS_MATCH))})})},e.prototype.identify=function(i){var n=this;return new Promise(function(e,t){var r=n.getQueryParameters(i),a={baseUrl:n.parameters.baseURL,verb:VERBS.IDENTIFY};try{if(1<r.length)e(oai_response_1.generateException(a,EXCEPTION_CODES.BAD_ARGUMENT));else{var o={Identify:[{repositoryName:n.parameters.repositoryName},{baseURL:n.parameters.baseURL},{protocolVersion:n.parameters.protocolVersion},{adminEmail:n.parameters.adminEmail},{earliestDatestamp:n.parameters.earliestDatestamp},{deletedRecord:n.parameters.deletedRecord},{granularity:n.parameters.granularity}]};e(oai_response_1.generateResponse(i,n.parameters.baseURL,o))}}catch(e){t(oai_response_1.generateException(a,EXCEPTION_CODES.BAD_ARGUMENT))}})},e.prototype.listSets=function(o){var i=this;return new Promise(function(e,t){var r=i.getQueryParameters(o),a={baseUrl:i.parameters.baseURL,verb:VERBS.LIST_SETS};2<r.length||2===r.length&&!i.hasKey(o,"resumptionToken")?e(oai_response_1.generateException(a,EXCEPTION_CODES.BAD_ARGUMENT)):e(oai_response_1.generateException(a,EXCEPTION_CODES.NO_SET_HIERARCHY))})},e.prototype.hasKey=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.prototype.getQueryParameters=function(t){return Object.keys(t).map(function(e){return t[e]})},e.prototype.hasValidSelectiveParams=function(e){return!e.until||!!e.from&&parseInt(e.from)<=parseInt(e.until)},e.prototype.hasSetSupport=function(){return this.oaiService.getProvider().setSupport},e.prototype.hasResumptionTokenSupport=function(){return this.oaiService.getProvider().resumptionSupport},e.prototype.isNotRecognizedParameter=function(e){var t=this;return!Object.keys(e).every(function(e){return 0<=t.possibleParams.indexOf(e)})},e.prototype.hasExclusiveParameterViolation=function(e,t){return 2===e.length&&!this.hasKey(t,"metadataPrefix")&&!this.hasKey(t,"resumptionToken")},e.prototype.hasInvalidListParameter=function(e,t){if(this.isNotRecognizedParameter(t))return!0;if(this.hasKey(t,"resumptionToken")){if(!this.hasResumptionTokenSupport())return!0}else{if(this.hasExclusiveParameterViolation(e,t))return!0;if(!this.hasValidSelectiveParams(t))return!0}return!1},e}();exports.CoreOaiProvider=CoreOaiProvider;