"use strict";var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(i,s,a,u){return new(a=a||Promise)(function(e,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function n(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}o((u=u.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var httpRequest_1=require("./httpRequest"),config_1=require("../config"),config_2=require("../config"),elasticsearch_1=require("../boostrap/elasticsearch"),arrays_1=require("../utils/arrays"),permission_utils_1=require("../utils/permission_utils"),reindex_1=require("../utils/reindex"),token_1=require("../utils/token"),vuejxServiceControl=function(r){function e(e){var t=r.call(this,config_1.PROJECT_SERVICE_HOST)||this;return t.path=""+config_1.PROJECT_SERVICE_HOST,t}return __extends(e,r),e.prototype.countDocumentES=function(o,i,s,a){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(s).concat("___").concat(a).concat("/").concat("_count"),[4,token_1.verify(o)];case 1:return(r=e.sent()).hasOwnProperty("tokenExpired")&&r.tokenExpired&&(r=null),[4,permission_utils_1.permissionQueryES(r,s,a,i)];case 2:return i=e.sent(),[4,this.search_rest(config_2.esConfig.host+t,i)];case 3:return n=e.sent(),[2,n.data]}})})},e.prototype.searchDocumentES=function(o,i,s,a){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(s).concat("___").concat(a).concat("/").concat("_search?request_cache=true"),[4,token_1.verify(o)];case 1:return(r=e.sent()).hasOwnProperty("tokenExpired")&&r.tokenExpired&&(r=null),[4,permission_utils_1.permissionQueryES(r,s,a,i)];case 2:return void 0!==(i=e.sent()).aggs&&null!==i.aggs&&delete i.aggs,[4,this.search_rest(config_2.esConfig.host+t,i)];case 3:return n=e.sent(),[2,n.data]}})})},e.prototype.aggsDocumentES=function(o,i,s,a,u){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(s).concat("___").concat(a).concat("/").concat("_search?request_cache=true"),[4,token_1.verify(o)];case 1:return(r=e.sent()).hasOwnProperty("tokenExpired")&&r.tokenExpired&&(r=null),"true"===u?[3,3]:[4,permission_utils_1.permissionQueryES(r,s,a,i)];case 2:i=e.sent(),e.label=3;case 3:return void 0===i.aggs||null===i.aggs?[3,5]:[4,this.search_rest(config_2.esConfig.host+t,i)];case 4:return n=e.sent(),[2,n.data];case 5:return[2,{}]}})})},e.prototype.countDocument=function(e,t,r,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.fetch_rest("http://localhost:8080/restheart",{})];case 1:throw e.sent(),new Error("Method not implemented.")}})})},e.prototype.searchDocument=function(n,o,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=o,0<String(o).indexOf("?")&&(t=String(o).substring(0,String(o).indexOf("?"))),null!=n&&""!==n&&(n=JSON.parse(n)),r={},delete i.query.count,i.query.count=!0,0<Object.keys(r).length&&(i.query.filter=r),[4,this.fetch_rest(this.path+t,{params:i.query})];case 1:return[2,e.sent().data]}})})},e.prototype.uploadPermission=function(r,e,t){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return null!=r&&""!==r&&(r=JSON.parse(r)),null===(t={})?[2,{status:200,permission:!0}]:[2,t]})})},e.prototype.asyncMongoOAI=function(s){return __awaiter(this,void 0,void 0,function(){var t,r,n,o,i;return __generator(this,function(e){switch(e.label){case 0:return t=s.query,r=void 0!==t.resumptionToken&&null!==t.resumptionToken&&""!==t.resumptionToken?parseInt(t.resumptionToken):1,n=[],void 0!==t.from&&null!==t.from&&""!==t.from&&n.push({modifiedAt:{$gt:new Date(t.from).getTime()}}),void 0!==t.until&&null!==t.until&&""!==t.until&&n.push({modifiedAt:{$lte:new Date(t.until).getTime()}}),o={params:{pagesize:config_1.PAGESIZE,page:r,count:!0,sort:{modifiedAt:-1}}},0<n.length&&(o.params.filter={$and:n}),[4,this.fetch_rest(this.path+"/"+t.metadataPrefix+"/"+t.set,o)];case 1:return(i=e.sent()).data.resumptionToken=r,[2,i.data]}})})},e.prototype.reindexDocument=function(t,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return reindex_1.reindexAPI(r,elasticsearch_1.elasticClient,t),[2,{status:200}]})})},e.prototype.reindexDocumentAll=function(i){return __awaiter(this,void 0,void 0,function(){var t,r,n,o;return __generator(this,function(e){switch(e.label){case 0:return null!=i&&""!==i?[3,1]:[2,{status:403}];case 1:return null!=i&&""!==i&&(i=JSON.parse(i)),[4,arrays_1.found(i.role,["admin"])];case 2:return e.sent()?[4,this.fetch_rest(this.path+"/vuejx_cfg/vuejx_collection",{params:{keys:{storeDb:1,shortName:1}}})]:[3,4];case 3:for(t=e.sent(),r=0,n=t.data;r<n.length;r++)o=n[r],"vuejx_cfg",void 0!==o.storeDb&&null!==o.storeDb&&""!==o.storeDb&&reindex_1.reindexStartUp("/"+o.storeDb+"/"+o.shortName,elasticsearch_1.elasticClient,i,"");return[3,5];case 4:return[2,{status:403}];case 5:return[2,{status:200}]}})})},e.prototype.repoExistOAI=function(t,e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return null!=t&&""!==t&&(t=JSON.parse(t)),[4,this.fetch_rest(this.path+"/vuejx_cfg/oai_pmh_config",{params:{pagesize:1,filter:{storeCollection:r},keys:{oai_identify_xml:1,modifiedAt:1}}})];case 1:return[2,e.sent().data._embedded[0]]}})})},e.prototype.oaiMetadataFormats=function(o,e,i){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return null!=o&&""!==o&&(o=JSON.parse(o)),r={_source:{includes:["metadataConfig","shortName"]},query:{bool:{must:[]}},size:1e4},(t=null)!=i&&""!==i&&r.query.bool.must.push({match:{shortName:i}}),[4,this.searchDocumentES(o,r,"vuejx_cfg","vuejx_collection")];case 1:return void 0!==(n=e.sent())&&0<n.hits.hits.length&&(t=n.hits.hits),[2,t]}})})},e.prototype.repoExistOAIES=function(o,i){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return o=JSON.parse(o),t=null,r={query:{bool:{must:[{match:{id:i}}],filter:{match:{type:"oai_pmh_config"}}}},size:1},[4,this.searchDocumentES(o,r,"vuejx_cfg","oai_pmh_config")];case 1:return void 0!==(n=e.sent())&&0<n.hits.hits.length&&(t=n.hits.hits[0]._source),[2,t]}})})},e.prototype.pullSourceMapper=function(e,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,{}]})})},e.prototype.processData=function(o,i,s){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return t=(new Date).getTime(),void 0!==o.order&&null!==o.order&&""!==o.order||(o.order=0),void 0!==o.site&&null!==o.site&&""!==o.site||(o.site="guest"),void 0!==o.storage&&null!==o.storage&&""!==o.storage||(o.storage="regular"),void 0!==o.openAccess&&null!==o.openAccess&&""!==o.openAccess||(o.openAccess=0),arrays_1.verifyBody(o),o.type=s,r={insert:0,update:0,delete:0},[4,this.fetch_rest(this.path+"/"+i+"/"+s,{params:{filter:{shortName:o.shortName}}})];case 1:return 0<e.sent().data.length?(o.modifiedAt=t,[4,this.put_rest(this.path+"/"+i+"/"+s,o)]):[3,3];case 2:return n=e.sent(),"200"===String(n.status)&&(r.update=1),[3,5];case 3:return o.createdAt=t,o.modifiedAt=t,[4,this.search_rest(this.path+"/"+i+"/"+s,o)];case 4:n=e.sent(),"201"===String(n.status)&&(r.insert=1),e.label=5;case 5:return[2,r]}})})},e.prototype.processLogs=function(o){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return t={},r=(new Date).getTime(),void 0!==t.order&&null!==t.order&&""!==t.order||(t.order=0),void 0!==t.site&&null!==t.site&&""!==t.site||(t.site="guest"),void 0!==t.storage&&null!==t.storage&&""!==t.storage||(t.storage="regular"),void 0!==t.openAccess&&null!==t.openAccess&&""!==t.openAccess||(t.openAccess=0),t.type="oai_pmh_async",t.createdAt=r,t.modifiedAt=r,t.shortName=r+"",t.title=r+"",t.inComingRecord=o.totalInput,t.inComingRecordRemove=o.totalRemove,t.inComingRecordState=o.insert+o.update,t.inComingRecordRemoveState=o.delete,t.storeDb=o.storeDb,t.storeCollection=o.storeCollection,t.storeCode=o.storeCode,[4,this.search_rest(this.path+"/vuejx_cfg/oai_pmh_async",t)];case 1:return n=e.sent(),String(n.status),[2]}})})},e.prototype.oaiGetDetail=function(n){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t={filter:{storage:"regular",openAccess:2}},[4,this.fetch_rest(this.path+"/"+n.metadataPrefix+"/"+n.set+"/"+n.identifier,{params:t}).catch(function(e){return null})];case 1:return null!==(r=e.sent())?[2,r.data]:[2,null]}})})},e.prototype.oaiMongoQuery=function(s){return __awaiter(this,void 0,void 0,function(){var t,r,n,o,i;return __generator(this,function(e){switch(e.label){case 0:return t=s.query,r=void 0!==t.resumptionToken&&null!==t.resumptionToken&&""!==t.resumptionToken?parseInt(t.resumptionToken):1,(n=[]).push({storage:"regular"}),n.push({openAccess:2}),void 0!==t.from&&null!==t.from&&""!==t.from&&n.push({modifiedAt:{$gt:new Date(t.from).getTime()}}),void 0!==t.until&&null!==t.until&&""!==t.until&&n.push({modifiedAt:{$lte:new Date(t.until).getTime()}}),o={params:{pagesize:config_1.PAGESIZE,page:r,count:!0,sort:{modifiedAt:-1},filter:{$and:n}}},[4,this.fetch_rest(this.path+"/"+t.metadataPrefix+"/"+t.set,o)];case 1:return(i=e.sent()).data.resumptionToken=r,[2,i.data]}})})},e}(httpRequest_1.default);exports.default=vuejxServiceControl;