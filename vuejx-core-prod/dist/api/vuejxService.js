"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(i,s,a,u){return new(a=a||Promise)(function(e,t){function n(e){try{o(u.next(e))}catch(e){t(e)}}function r(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}o((u=u.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(n,r){var o,i,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var httpRequest_1=require("./httpRequest"),config_1=require("../config"),config_2=require("../config"),arrays_1=require("../utils/arrays"),permission_utils_1=require("../utils/permission_utils"),token_1=require("../utils/token"),mongoose=require("mongoose"),config_3=require("../config"),Schema=mongoose.Schema,api_1=require("../api"),ObjectId=require("mongodb").ObjectId,vuejxServiceControl=function(n){function e(e){var t=n.call(this,config_1.PROJECT_SERVICE_HOST)||this;return t.path=""+config_1.PROJECT_SERVICE_HOST,t}return __extends(e,n),e.prototype.countDocumentESSys=function(o,i,s){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(i).concat("___").concat(s).concat("/").concat("_count"),[4,this.search_rest(config_2.esConfig.host+t,o)];case 1:return n=e.sent(),void 0!==(r=n.data).count&&null!==r.count?[2,r.count]:[2,0]}})})},e.prototype.countDocumentES=function(o,i,s,a){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(s).concat("___").concat(a).concat("/").concat("_count"),[4,token_1.verify(o)];case 1:return null!=(n=e.sent())&&n.hasOwnProperty("tokenExpired")&&n.tokenExpired&&(n=null),[4,permission_utils_1.permissionQueryES(n,s,a,i)];case 2:return i=e.sent(),[4,this.search_rest(config_2.esConfig.host+t,i)];case 3:return r=e.sent(),[2,r.data]}})})},e.prototype.mappingDocumentES=function(e,s,a,u){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:for(n in t=[],s)t.push(n);r=0,e.label=1;case 1:return r<t.length?(o=t[r],(i={properties:{}}).properties[o]={type:s[o]},"text"===s[o]&&(i.properties[o].fielddata=!0),[4,this.put_rest(config_2.esConfig.host+"/"+a+"___"+u+"/_mapping",i,{headers:{"Content-Type":"application/json"}})]):[3,4];case 2:e.sent(),e.label=3;case 3:return r++,[3,1];case 4:return[2]}})})},e.prototype.searchDocumentES=function(s,a,u,c){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(u).concat("___").concat(c).concat("/").concat("_search?request_cache=true"),[4,token_1.verify(s)];case 1:return null!=(n=e.sent())&&n.hasOwnProperty("tokenExpired")&&n.tokenExpired&&(n=null),[4,permission_utils_1.permissionQueryES(n,u,c,a)];case 2:return void 0!==(a=e.sent()).aggs&&null!==a.aggs&&delete a.aggs,[4,this.search_rest(config_2.esConfig.host+t,a)];case 3:return r=e.sent(),null==(o=r.data)||"gte"!==o.hits.total.relation?[3,5]:(delete a.sort,delete a._source,delete a.from,delete a.size,i=o.hits.total,[4,this.countDocumentESSys(a,u,c)]);case 4:i.value=e.sent(),o.hits.total.relation="eq",e.label=5;case 5:return[2,o]}})})},e.prototype.aggsDocumentES=function(o,i,s,a,u){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(s).concat("___").concat(a).concat("/").concat("_search?request_cache=true"),[4,token_1.verify(o)];case 1:return null!=(n=e.sent())&&n.hasOwnProperty("tokenExpired")&&n.tokenExpired&&(n=null),"true"===u?[3,3]:[4,permission_utils_1.permissionQueryES(n,s,a,i)];case 2:i=e.sent(),e.label=3;case 3:return void 0===i.aggs||null===i.aggs?[3,5]:[4,this.search_rest(config_2.esConfig.host+t,i)];case 4:return r=e.sent(),[2,r.data];case 5:return[2,{}]}})})},e.prototype.asyncMongoOAI=function(u){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i,s,a;return __generator(this,function(e){switch(e.label){case 0:return t=u.query,n=void 0!==t.resumptionToken&&null!==t.resumptionToken&&""!==t.resumptionToken?parseInt(t.resumptionToken):1,r=[],void 0!==t.from&&null!==t.from&&""!==t.from&&r.push({modifiedAt:{$gt:new Date(t.from).getTime()}}),void 0!==t.until&&null!==t.until&&""!==t.until&&r.push({modifiedAt:{$lte:new Date(t.until).getTime()}}),o={params:{pagesize:config_1.PAGESIZE,page:n,count:!0,sort:{modifiedAt:-1}}},0<r.length&&(o.params.filter={$and:r}),[4,api_1.vuejxQueryService.findData(t.metadataPrefix,t.set,o.params.filter,{modifiedAt:-1},0,1e3,null)];case 1:return i=e.sent(),[4,config_3.getClient().db(t.metadataPrefix).collection(t.set).find(o.params.filter).count()];case 2:return s=e.sent(),(a={}).resumptionToken=n,a._size=s,a._embedded=i,[2,a]}})})},e.prototype.repoExistOAI=function(t,n,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return null!=t&&""!==t&&(t=JSON.parse(t)),[4,config_3.getClient().db(n).collection(r).findOne({storeCollection:r})];case 1:return[2,e.sent()]}})})},e.prototype.oaiMetadataFormats=function(o,e,i){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return null!=o&&""!==o&&(o=JSON.parse(o)),n={_source:{includes:["metadataConfig","shortName"]},query:{bool:{must:[]}},size:1e4},(t=null)!=i&&""!==i&&n.query.bool.must.push({match:{shortName:i}}),[4,this.searchDocumentES(o,n,"vuejx_cfg","vuejx_collection")];case 1:return void 0!==(r=e.sent())&&0<r.hits.hits.length&&(t=r.hits.hits),[2,t]}})})},e.prototype.repoExistOAIES=function(o,i){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return o=JSON.parse(o),t=null,n={query:{bool:{must:[{match:{id:i}}],filter:{match:{type:"oai_pmh_config"}}}},size:1},[4,this.searchDocumentES(o,n,"vuejx_cfg","oai_pmh_config")];case 1:return void 0!==(r=e.sent())&&0<r.hits.hits.length&&(t=r.hits.hits[0]._source),[2,t]}})})},e.prototype.pullSourceMapper=function(e,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,{}]})})},e.prototype.processData=function(o,i,s){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t=(new Date).getTime(),void 0!==o.order&&null!==o.order&&""!==o.order||(o.order=0),void 0!==o.site&&null!==o.site&&""!==o.site||(o.site="guest"),void 0!==o.storage&&null!==o.storage&&""!==o.storage||(o.storage="regular"),void 0!==o.openAccess&&null!==o.openAccess&&""!==o.openAccess||(o.openAccess=0),arrays_1.verifyBody(o),o.type=s,n={insert:0,update:0,delete:0},[4,config_3.getClient().db(i).collection(s).findOne({shortName:o.shortName})];case 1:return 0<(r=e.sent()).data.length?(o.modifiedAt=t,[4,config_3.getClient().db(i).collection(s).updateOne({_id:new ObjectId(r._id)},{$set:o})]):[3,3];case 2:return 0<e.sent().modifiedCount&&(n.update=1),[3,5];case 3:return o.createdAt=t,o.modifiedAt=t,[4,config_3.getClient().db(i).collection(s).insertOne(o)];case 4:0<e.sent().insertedCount&&(n.insert=1),e.label=5;case 5:return[2,n]}})})},e.prototype.oaiGetDetail=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=String(n.identifier),(void 0)._id=new ObjectId(t),[4,config_3.getClient().db(n.metadataPrefix).collection(n.set).findOne(void 0)];case 1:return[2,e.sent()]}})})},e.prototype.oaiMongoQuery=function(u){return __awaiter(this,void 0,void 0,function(){var t,n,r,o,i,s,a;return __generator(this,function(e){switch(e.label){case 0:return t=u.query,n=void 0!==t.resumptionToken&&null!==t.resumptionToken&&""!==t.resumptionToken?parseInt(t.resumptionToken):1,(r=[]).push({storage:"regular"}),r.push({openAccess:2}),void 0!==t.from&&null!==t.from&&""!==t.from&&r.push({modifiedAt:{$gt:new Date(t.from).getTime()}}),void 0!==t.until&&null!==t.until&&""!==t.until&&r.push({modifiedAt:{$lte:new Date(t.until).getTime()}}),o={params:{pagesize:config_1.PAGESIZE,page:n,count:!0,sort:{modifiedAt:-1},filter:{$and:r}}},[4,api_1.vuejxQueryService.findData(t.metadataPrefix,t.set,o.params.filter,{modifiedAt:-1},0,1e3,null)];case 1:return i=e.sent(),[4,config_3.getClient().db(t.metadataPrefix).collection(t.set).find(o.params.filter).count()];case 2:return s=e.sent(),(a={}).resumptionToken=n,a._size=s,a._embedded=i,[2,a]}})})},e}(httpRequest_1.default);exports.default=vuejxServiceControl;