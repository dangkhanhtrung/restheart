"use strict";var __extends=this&&this.__extends||function(){var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(i,o,a,u){return new(a=a||Promise)(function(e,t){function r(e){try{n(u.next(e))}catch(e){t(e)}}function s(e){try{n(u.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,s)}n((u=u.apply(i,o||[])).next())})},__generator=this&&this.__generator||function(r,s){var n,i,o,e,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(o=0<(o=a.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){a.label=t[1];break}if(6===t[0]&&a.label<o[1]){a.label=o[1],o=t;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(t);break}o[2]&&a.ops.pop(),a.trys.pop();continue}t=s.call(r,a)}catch(e){t=[6,e],i=0}finally{n=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var httpRequest_1=require("./httpRequest"),config_1=require("../config"),config_2=require("../config"),elasticsearch_1=require("../boostrap/elasticsearch"),constant_1=require("../constant"),arrays_1=require("../utils/arrays"),permission_es_1=require("../utils/permission_es"),reindex_1=require("../utils/reindex"),permission_utils_1=require("../utils/permission_utils"),vuejxServiceControl=function(r){function e(e){var t=r.call(this,config_1.PROJECT_SERVICE_HOST)||this;return t.path=""+config_1.PROJECT_SERVICE_HOST,t}return __extends(e,r),e.prototype.countDocumentES=function(e,s,n,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(n).concat("___").concat(i).concat("/").concat("_count"),[4,this.search_rest(config_2.esConfig.host+t,s)];case 1:return r=e.sent(),[2,r.data]}})})},e.prototype.searchDocumentES=function(e,s,n,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(n).concat("___").concat(i).concat("/").concat("_search?request_cache=true"),void 0!==s.aggs&&null!==s.aggs&&delete s.aggs,[4,this.search_rest(config_2.esConfig.host+t,s)];case 1:return r=e.sent(),[2,r.data]}})})},e.prototype.aggsDocumentES=function(e,s,n,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t="/".concat(n).concat("___").concat(i).concat("/").concat("_search?request_cache=true"),void 0===s.aggs||null===s.aggs?[3,2]:[4,this.search_rest(config_2.esConfig.host+t,s)];case 1:return r=e.sent(),[2,r.data];case 2:return[2,{}]}})})},e.prototype.countDocument=function(e,t,r,s){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.fetch_rest("http://localhost:8080/restheart",{})];case 1:throw e.sent(),new Error("Method not implemented.")}})})},e.prototype.searchDocument=function(s,n,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=n,0<String(n).indexOf("?")&&(t=String(n).substring(0,String(n).indexOf("?"))),null!=s&&""!==s&&(s=JSON.parse(s)),[4,permission_utils_1.permission(this.path,s,n,i,elasticsearch_1.elasticClient,{})];case 1:return r=e.sent(),delete i.query.count,i.query.count=!0,0<Object.keys(r).length&&(i.query.filter=r),[4,this.fetch_rest(this.path+t,{params:i.query})];case 2:return[2,e.sent().data]}})})},e.prototype.postDocument=function(a,u,c){return __awaiter(this,void 0,void 0,function(){var t,r,s,n,i,o;return __generator(this,function(e){switch(e.label){case 0:return c.request.body.createdAt=(new Date).getTime(),c.request.body.modifiedAt=(new Date).getTime(),void 0!==c.request.body.order&&null!==c.request.body.order&&""!==c.request.body.order||(c.request.body.order=0),void 0!==c.request.body.site&&null!==c.request.body.site&&""!==c.request.body.site||(c.request.body.site="guest"),void 0!==c.request.body.storage&&null!==c.request.body.storage&&""!==c.request.body.storage||(c.request.body.storage="regular"),void 0!==c.request.body.openAccess&&null!==c.request.body.openAccess&&""!==c.request.body.openAccess||(c.request.body.openAccess=0),arrays_1.verifyBody(c.request.body),t=u,0<String(u).indexOf("?")&&(t=String(u).substring(0,String(u).indexOf("?"))),r=t.split("/"),r[0],r[1],s=r[2],r[3],"vuejx_collection"===s&&(void 0!==c.request.body.rightMode&&null!==c.request.body.rightMode&&""!==c.request.body.rightMode||(c.request.body.rightMode=0),void 0!==c.request.body.publicAccess&&null!==c.request.body.publicAccess&&""!==c.request.body.publicAccess||(c.request.body.publicAccess=0)),c.request.body.type=s,null!=a&&""!==a&&(a=JSON.parse(a)),c.request.body.username=a.username,[4,permission_utils_1.permission(this.path,a,u,c,elasticsearch_1.elasticClient,c.request.body)];case 1:return n=e.sent(),[4,permission_es_1.permissionES(this.path,a,u,c,elasticsearch_1.elasticClient)];case 2:return i=e.sent(),null!==n||null!==i?[3,4]:[4,this.search_rest(this.path+u,c.request.body).catch(function(e){return{status:e.response.status,data:e.response.data}})];case 3:return o=e.sent(),"201"!==String(o.status)&&"200"!==String(o.status)||reindex_1.reindex(u,elasticsearch_1.elasticClient,a,c.request.body.modifiedAt),[2,{status:o.status,data:o.data}];case 4:return[2,n]}})})},e.prototype.putDocument=function(a,u,c){return __awaiter(this,void 0,void 0,function(){var t,r,s,n,i,o;return __generator(this,function(e){switch(e.label){case 0:return t=u,0<String(u).indexOf("?")&&(t=String(u).substring(0,String(u).indexOf("?"))),r=t.split("/"),r[0],r[1],s=r[2],r[3],"vuejx_collection"===s&&(void 0!==c.request.body.rightMode&&null!==c.request.body.rightMode&&""!==c.request.body.rightMode||(c.request.body.rightMode=0),void 0!==c.request.body.publicAccess&&null!==c.request.body.publicAccess&&""!==c.request.body.publicAccess||(c.request.body.publicAccess=0)),c.request.body.type=s,null!=a&&""!==a&&(a=JSON.parse(a)),"_schemas"!==s?(c.request.body.modifiedAt=(new Date).getTime(),void 0!==c.request.body.order&&null!==c.request.body.order&&""!==c.request.body.order||(c.request.body.order=0),c.request.body.username=a.username):(delete c.request.body.username,delete c.request.body.type),delete c.request.body._etag,[4,permission_utils_1.permission(this.path,a,u,c,elasticsearch_1.elasticClient,c.request.body)];case 1:return n=e.sent(),[4,permission_es_1.permissionES(this.path,a,u,c,elasticsearch_1.elasticClient)];case 2:return i=e.sent(),null!==n||null!==i?[3,4]:[4,this.put_rest(this.path+u,c.request.body,{})];case 3:return o=e.sent(),"201"!==String(o.status)&&"200"!==String(o.status)||(reindex_1.reindex(u,elasticsearch_1.elasticClient,a,c.request.body.modifiedAt),void 0!==c.request.body.schema&&null!==c.request.body.schema&&""!==c.request.body.schema&&"vuejx_collection"===s&&this.put_rest(this.path+"/"+c.request.body.storeDb+"/"+c.request.body.shortName,{checkers:[{name:"jsonSchema",args:{schemaId:c.request.body.schema,schemaStoreDb:"vuejx_cfg"}}]}),void 0!==c.request.body.storeDb&&null!==c.request.body.storeDb&&""!==c.request.body.storeDb&&"aggrs"===s&&this.put_rest(this.path+"/"+c.request.body.storeDb+"/"+c.request.body.shortName,c.request.body.tableConfig,{headers:{"Content-Type":"application/json"}})),[2,{status:o.status,data:o.data}];case 4:return[2,n]}})})},e.prototype.deleteDocument=function(c,l,d){return __awaiter(this,void 0,void 0,function(){var t,r,s,n,i,o,a,u;return __generator(this,function(e){switch(e.label){case 0:return null!=c&&""!==c&&(c=JSON.parse(c)),[4,permission_utils_1.permission(this.path,c,l,d,elasticsearch_1.elasticClient,{})];case 1:return null!==(t=e.sent())?[3,7]:(r={},[4,arrays_1.found(c.role,["admin"])]);case 2:return e.sent()?[4,this.delete_rest(this.path+l.substring(0,l.indexOf("?")),{})]:[3,4];case 3:return 204===(r=e.sent()).status&&(s=l,0<String(l).indexOf("?")&&(s=String(l).substring(0,String(l).indexOf("?"))),n=s.split("/"),n[0],i=n[1],o=n[2],a=n[3],u=0<a.indexOf("?")?a.substring(0,a.indexOf("?")):a,elasticsearch_1.deleteDocument(elasticsearch_1.elasticClient,i+"___"+o,constant_1._TYPE,u)),[3,6];case 4:return[4,this.put_rest(this.path+l.substring(0,l.indexOf("?")),{storage:"trash"})];case 5:200===(r=e.sent()).status&&reindex_1.reindex(l,elasticsearch_1.elasticClient,c,d.request.body.modifiedAt),e.label=6;case 6:return[2,{status:r.status}];case 7:return[2,t]}})})},e.prototype.pullMongoQuery=function(i){return __awaiter(this,void 0,void 0,function(){var t,r,s,n;return __generator(this,function(e){switch(e.label){case 0:return t=i.query,[4,permission_es_1.permissionQuery(i.request.header.user,i.originalUrl)];case 1:return r=e.sent(),[4,this.fetch_rest(this.path+"/"+t.metadataPrefix+"/"+t.set+"/_size",{params:{pagesize:config_1.PAGESIZE,filter:r}})];case 2:return s=e.sent(),[4,this.fetch_rest(this.path+"/"+t.metadataPrefix+"/"+t.set,{params:{pagesize:config_1.PAGESIZE,sort:{modifiedAt:-1},filter:r}})];case 3:return n=e.sent(),[2,{total:s.data._size,data:n.data}]}})})},e.prototype.asyncMongoOAI=function(o){return __awaiter(this,void 0,void 0,function(){var t,r,s,n,i;return __generator(this,function(e){switch(e.label){case 0:return t=o.query,r=void 0!==t.resumptionToken&&null!==t.resumptionToken&&""!==t.resumptionToken?parseInt(t.resumptionToken):1,s=[],void 0!==t.from&&null!==t.from&&""!==t.from&&s.push({modifiedAt:{$gt:new Date(t.from).getTime()}}),void 0!==t.until&&null!==t.until&&""!==t.until&&s.push({modifiedAt:{$lte:new Date(t.until).getTime()}}),n={params:{pagesize:config_1.PAGESIZE,page:r,count:!0,sort:{modifiedAt:-1}}},0<s.length&&(n.params.filter={$and:s}),[4,this.fetch_rest(this.path+"/"+t.metadataPrefix+"/"+t.set,n)];case 1:return(i=e.sent()).data.resumptionToken=r,[2,i.data]}})})},e.prototype.reindexDocument=function(t,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return reindex_1.reindexAPI(r,elasticsearch_1.elasticClient,t),[2,{status:200}]})})},e.prototype.reindexDocumentAll=function(i){return __awaiter(this,void 0,void 0,function(){var t,r,s,n;return __generator(this,function(e){switch(e.label){case 0:return null!=i&&""!==i?[3,1]:[2,{status:403}];case 1:return null!=i&&""!==i&&(i=JSON.parse(i)),[4,arrays_1.found(i.role,["admin"])];case 2:return e.sent()?[4,this.fetch_rest(this.path+"/vuejx_cfg/vuejx_collection",{params:{keys:{storeDb:1,shortName:1}}})]:[3,4];case 3:for(t=e.sent(),r=0,s=t.data;r<s.length;r++)n=s[r],"vuejx_cfg",void 0!==n.storeDb&&null!==n.storeDb&&""!==n.storeDb&&reindex_1.reindexStartUp("/"+n.storeDb+"/"+n.shortName,elasticsearch_1.elasticClient,i,"");return[3,5];case 4:return[2,{status:403}];case 5:return[2,{status:200}]}})})},e.prototype.repoExistOAI=function(t,e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return null!=t&&""!==t&&(t=JSON.parse(t)),[4,this.fetch_rest(this.path+"/vuejx_cfg/oai_pmh_config",{params:{pagesize:1,filter:{storeCollection:r},keys:{oai_identify_xml:1,modifiedAt:1}}})];case 1:return[2,e.sent().data._embedded[0]]}})})},e.prototype.oaiMetadataFormats=function(n,e,i){return __awaiter(this,void 0,void 0,function(){var t,r,s;return __generator(this,function(e){switch(e.label){case 0:return null!=n&&""!==n&&(n=JSON.parse(n)),r={_source:{includes:["metadataConfig","shortName"]},query:{bool:{must:[]}},size:1e4},(t=null)!=i&&""!==i&&r.query.bool.must.push({match:{shortName:i}}),[4,this.searchDocumentES(n,r,"vuejx_cfg","vuejx_collection")];case 1:return void 0!==(s=e.sent())&&0<s.hits.hits.length&&(t=s.hits.hits),[2,t]}})})},e.prototype.repoExistOAIES=function(n,i){return __awaiter(this,void 0,void 0,function(){var t,r,s;return __generator(this,function(e){switch(e.label){case 0:return n=JSON.parse(n),t=null,r={query:{bool:{must:[{match:{id:i}}],filter:{match:{type:"oai_pmh_config"}}}},size:1},[4,this.searchDocumentES(n,r,"vuejx_cfg","oai_pmh_config")];case 1:return void 0!==(s=e.sent())&&0<s.hits.hits.length&&(t=s.hits.hits[0]._source),[2,t]}})})},e.prototype.pullSourceMapper=function(e,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,{}]})})},e.prototype.processData=function(n,i,o){return __awaiter(this,void 0,void 0,function(){var t,r,s;return __generator(this,function(e){switch(e.label){case 0:return t=(new Date).getTime(),void 0!==n.order&&null!==n.order&&""!==n.order||(n.order=0),void 0!==n.site&&null!==n.site&&""!==n.site||(n.site="guest"),void 0!==n.storage&&null!==n.storage&&""!==n.storage||(n.storage="regular"),void 0!==n.openAccess&&null!==n.openAccess&&""!==n.openAccess||(n.openAccess=0),arrays_1.verifyBody(n),n.type=o,r={insert:0,update:0,delete:0},[4,this.fetch_rest(this.path+"/"+i+"/"+o,{params:{filter:{shortName:n.shortName}}})];case 1:return 0<e.sent().data.length?(n.modifiedAt=t,[4,this.put_rest(this.path+"/"+i+"/"+o,n)]):[3,3];case 2:return s=e.sent(),"200"===String(s.status)&&(r.update=1),[3,5];case 3:return n.createdAt=t,n.modifiedAt=t,[4,this.search_rest(this.path+"/"+i+"/"+o,n)];case 4:s=e.sent(),"201"===String(s.status)&&(r.insert=1),e.label=5;case 5:return reindex_1.reindex("/"+i+"/"+o,elasticsearch_1.elasticClient,null,String(t)),[2,r]}})})},e.prototype.processLogs=function(n){return __awaiter(this,void 0,void 0,function(){var t,r,s;return __generator(this,function(e){switch(e.label){case 0:return t={},r=(new Date).getTime(),void 0!==t.order&&null!==t.order&&""!==t.order||(t.order=0),void 0!==t.site&&null!==t.site&&""!==t.site||(t.site="guest"),void 0!==t.storage&&null!==t.storage&&""!==t.storage||(t.storage="regular"),void 0!==t.openAccess&&null!==t.openAccess&&""!==t.openAccess||(t.openAccess=0),t.type="oai_pmh_async",t.createdAt=r,t.modifiedAt=r,t.shortName=r+"",t.title=r+"",t.inComingRecord=n.totalInput,t.inComingRecordRemove=n.totalRemove,t.inComingRecordState=n.insert+n.update,t.inComingRecordRemoveState=n.delete,t.storeDb=n.storeDb,t.storeCollection=n.storeCollection,t.storeCode=n.storeCode,[4,this.search_rest(this.path+"/vuejx_cfg/oai_pmh_async",t)];case 1:return s=e.sent(),"201"===String(s.status)&&reindex_1.reindex("/vuejx_cfg/oai_pmh_async",elasticsearch_1.elasticClient,null,String(r)),[2]}})})},e.prototype.oaiGetDetail=function(s){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t={filter:{storage:"regular",openAccess:2}},[4,this.fetch_rest(this.path+"/"+s.metadataPrefix+"/"+s.set+"/"+s.identifier,{params:t}).catch(function(e){return null})];case 1:return null!==(r=e.sent())?[2,r.data]:[2,null]}})})},e.prototype.oaiMongoQuery=function(o){return __awaiter(this,void 0,void 0,function(){var t,r,s,n,i;return __generator(this,function(e){switch(e.label){case 0:return t=o.query,r=void 0!==t.resumptionToken&&null!==t.resumptionToken&&""!==t.resumptionToken?parseInt(t.resumptionToken):1,(s=[]).push({storage:"regular"}),s.push({openAccess:2}),void 0!==t.from&&null!==t.from&&""!==t.from&&s.push({modifiedAt:{$gt:new Date(t.from).getTime()}}),void 0!==t.until&&null!==t.until&&""!==t.until&&s.push({modifiedAt:{$lte:new Date(t.until).getTime()}}),n={params:{pagesize:config_1.PAGESIZE,page:r,count:!0,sort:{modifiedAt:-1},filter:{$and:s}}},[4,this.fetch_rest(this.path+"/"+t.metadataPrefix+"/"+t.set,n)];case 1:return(i=e.sent()).data.resumptionToken=r,[2,i.data]}})})},e}(httpRequest_1.default);exports.default=vuejxServiceControl;