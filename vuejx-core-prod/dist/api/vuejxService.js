"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(i,s,a,u){return new(a=a||Promise)(function(t,e){function r(t){try{o(u.next(t))}catch(t){e(t)}}function n(t){try{o(u.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new a(function(t){t(e.value)}).then(r,n)}o((u=u.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(s=2&e[0]?i.return:e[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,i=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){a.label=e[1];break}if(6===e[0]&&a.label<s[1]){a.label=s[1],s=e;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(e);break}s[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(r,a)}catch(t){e=[6,t],i=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var httpRequest_1=require("./httpRequest"),config_1=require("../config"),config_2=require("../config"),elasticsearch_1=require("../boostrap/elasticsearch"),arrays_1=require("../utils/arrays"),permission_utils_1=require("../utils/permission_utils"),reindex_1=require("../utils/reindex"),token_1=require("../utils/token"),vuejxServiceControl=function(r){function t(t){var e=r.call(this,config_1.PROJECT_SERVICE_HOST)||this;return e.path=""+config_1.PROJECT_SERVICE_HOST,e}return __extends(t,r),t.prototype.countDocumentESSys=function(o,i,s){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return e="/".concat(i).concat("___").concat(s).concat("/").concat("_count"),[4,this.search_rest(config_2.esConfig.host+e,o)];case 1:return r=t.sent(),void 0!==(n=r.data).count&&null!==n.count?[2,n.count]:[2,0]}})})},t.prototype.countDocumentES=function(o,i,s,a){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return e="/".concat(s).concat("___").concat(a).concat("/").concat("_count"),[4,token_1.verify(o)];case 1:return(r=t.sent()).hasOwnProperty("tokenExpired")&&r.tokenExpired&&(r=null),[4,permission_utils_1.permissionQueryES(r,s,a,i)];case 2:return i=t.sent(),[4,this.search_rest(config_2.esConfig.host+e,i)];case 3:return n=t.sent(),[2,n.data]}})})},t.prototype.mappingDocumentES=function(t,r,n,o){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return(e={properties:{}}).properties[r]={type:"text",fielddata:!0},[4,this.put_rest(config_2.esConfig.host+"/"+n+"___"+o+"/_mapping",e,{headers:{"Content-Type":"application/json"}})];case 1:return t.sent(),[2]}})})},t.prototype.searchDocumentES=function(s,a,u,c){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i;return __generator(this,function(t){switch(t.label){case 0:return e="/".concat(u).concat("___").concat(c).concat("/").concat("_search?request_cache=true"),[4,token_1.verify(s)];case 1:return(r=t.sent()).hasOwnProperty("tokenExpired")&&r.tokenExpired&&(r=null),[4,permission_utils_1.permissionQueryES(r,u,c,a)];case 2:return void 0!==(a=t.sent()).aggs&&null!==a.aggs&&delete a.aggs,[4,this.search_rest(config_2.esConfig.host+e,a)];case 3:return n=t.sent(),null==(o=n.data)||"gte"!==o.hits.total.relation?[3,5]:(delete a.sort,delete a._source,delete a.from,delete a.size,i=o.hits.total,[4,this.countDocumentESSys(a,u,c)]);case 4:i.value=t.sent(),o.hits.total.relation="eq",t.label=5;case 5:return[2,o]}})})},t.prototype.aggsDocumentES=function(o,i,s,a,u){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return e="/".concat(s).concat("___").concat(a).concat("/").concat("_search?request_cache=true"),[4,token_1.verify(o)];case 1:return(r=t.sent()).hasOwnProperty("tokenExpired")&&r.tokenExpired&&(r=null),"true"===u?[3,3]:[4,permission_utils_1.permissionQueryES(r,s,a,i)];case 2:i=t.sent(),t.label=3;case 3:return void 0===i.aggs||null===i.aggs?[3,5]:[4,this.search_rest(config_2.esConfig.host+e,i)];case 4:return n=t.sent(),[2,n.data];case 5:return[2,{}]}})})},t.prototype.countDocument=function(t,e,r,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.fetch_rest("http://localhost:8080/restheart",{})];case 1:throw t.sent(),new Error("Method not implemented.")}})})},t.prototype.searchDocument=function(n,o,i){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return e=o,0<String(o).indexOf("?")&&(e=String(o).substring(0,String(o).indexOf("?"))),null!=n&&""!==n&&(n=JSON.parse(n)),r={},delete i.query.count,i.query.count=!0,0<Object.keys(r).length&&(i.query.filter=r),[4,this.fetch_rest(this.path+e,{params:i.query})];case 1:return[2,t.sent().data]}})})},t.prototype.uploadPermission=function(r,t,e){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){return null!=r&&""!==r&&(r=JSON.parse(r)),null===(e={})?[2,{status:200,permission:!0}]:[2,e]})})},t.prototype.asyncMongoOAI=function(s){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i;return __generator(this,function(t){switch(t.label){case 0:return e=s.query,r=void 0!==e.resumptionToken&&null!==e.resumptionToken&&""!==e.resumptionToken?parseInt(e.resumptionToken):1,n=[],void 0!==e.from&&null!==e.from&&""!==e.from&&n.push({modifiedAt:{$gt:new Date(e.from).getTime()}}),void 0!==e.until&&null!==e.until&&""!==e.until&&n.push({modifiedAt:{$lte:new Date(e.until).getTime()}}),o={params:{pagesize:config_1.PAGESIZE,page:r,count:!0,sort:{modifiedAt:-1}}},0<n.length&&(o.params.filter={$and:n}),[4,this.fetch_rest(this.path+"/"+e.metadataPrefix+"/"+e.set,o)];case 1:return(i=t.sent()).data.resumptionToken=r,[2,i.data]}})})},t.prototype.reindexDocument=function(e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return reindex_1.reindexAPI(r,elasticsearch_1.elasticClient,e),[2,{status:200}]})})},t.prototype.reindexDocumentAll=function(i){return __awaiter(this,void 0,void 0,function(){var e,r,n,o;return __generator(this,function(t){switch(t.label){case 0:return null!=i&&""!==i?[3,1]:[2,{status:403}];case 1:return null!=i&&""!==i&&(i=JSON.parse(i)),[4,arrays_1.found(i.role,["admin"])];case 2:return t.sent()?[4,this.fetch_rest(this.path+"/vuejx_cfg/vuejx_collection",{params:{keys:{storeDb:1,shortName:1}}})]:[3,4];case 3:for(e=t.sent(),r=0,n=e.data;r<n.length;r++)o=n[r],"vuejx_cfg",void 0!==o.storeDb&&null!==o.storeDb&&""!==o.storeDb&&reindex_1.reindexStartUp("/"+o.storeDb+"/"+o.shortName,elasticsearch_1.elasticClient,i,"");return[3,5];case 4:return[2,{status:403}];case 5:return[2,{status:200}]}})})},t.prototype.repoExistOAI=function(e,t,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return null!=e&&""!==e&&(e=JSON.parse(e)),[4,this.fetch_rest(this.path+"/vuejx_cfg/oai_pmh_config",{params:{pagesize:1,filter:{storeCollection:r},keys:{oai_identify_xml:1,modifiedAt:1}}})];case 1:return[2,t.sent().data._embedded[0]]}})})},t.prototype.oaiMetadataFormats=function(o,t,i){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return null!=o&&""!==o&&(o=JSON.parse(o)),r={_source:{includes:["metadataConfig","shortName"]},query:{bool:{must:[]}},size:1e4},(e=null)!=i&&""!==i&&r.query.bool.must.push({match:{shortName:i}}),[4,this.searchDocumentES(o,r,"vuejx_cfg","vuejx_collection")];case 1:return void 0!==(n=t.sent())&&0<n.hits.hits.length&&(e=n.hits.hits),[2,e]}})})},t.prototype.repoExistOAIES=function(o,i){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return o=JSON.parse(o),e=null,r={query:{bool:{must:[{match:{id:i}}],filter:{match:{type:"oai_pmh_config"}}}},size:1},[4,this.searchDocumentES(o,r,"vuejx_cfg","oai_pmh_config")];case 1:return void 0!==(n=t.sent())&&0<n.hits.hits.length&&(e=n.hits.hits[0]._source),[2,e]}})})},t.prototype.pullSourceMapper=function(t,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{}]})})},t.prototype.processData=function(o,i,s){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return e=(new Date).getTime(),void 0!==o.order&&null!==o.order&&""!==o.order||(o.order=0),void 0!==o.site&&null!==o.site&&""!==o.site||(o.site="guest"),void 0!==o.storage&&null!==o.storage&&""!==o.storage||(o.storage="regular"),void 0!==o.openAccess&&null!==o.openAccess&&""!==o.openAccess||(o.openAccess=0),arrays_1.verifyBody(o),o.type=s,r={insert:0,update:0,delete:0},[4,this.fetch_rest(this.path+"/"+i+"/"+s,{params:{filter:{shortName:o.shortName}}})];case 1:return 0<t.sent().data.length?(o.modifiedAt=e,[4,this.put_rest(this.path+"/"+i+"/"+s,o)]):[3,3];case 2:return n=t.sent(),"200"===String(n.status)&&(r.update=1),[3,5];case 3:return o.createdAt=e,o.modifiedAt=e,[4,this.search_rest(this.path+"/"+i+"/"+s,o)];case 4:n=t.sent(),"201"===String(n.status)&&(r.insert=1),t.label=5;case 5:return[2,r]}})})},t.prototype.processLogs=function(o){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return e={},r=(new Date).getTime(),void 0!==e.order&&null!==e.order&&""!==e.order||(e.order=0),void 0!==e.site&&null!==e.site&&""!==e.site||(e.site="guest"),void 0!==e.storage&&null!==e.storage&&""!==e.storage||(e.storage="regular"),void 0!==e.openAccess&&null!==e.openAccess&&""!==e.openAccess||(e.openAccess=0),e.type="oai_pmh_async",e.createdAt=r,e.modifiedAt=r,e.shortName=r+"",e.title=r+"",e.inComingRecord=o.totalInput,e.inComingRecordRemove=o.totalRemove,e.inComingRecordState=o.insert+o.update,e.inComingRecordRemoveState=o.delete,e.storeDb=o.storeDb,e.storeCollection=o.storeCollection,e.storeCode=o.storeCode,[4,this.search_rest(this.path+"/vuejx_cfg/oai_pmh_async",e)];case 1:return n=t.sent(),String(n.status),[2]}})})},t.prototype.oaiGetDetail=function(n){return __awaiter(this,void 0,void 0,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return e={filter:{storage:"regular",openAccess:2}},[4,this.fetch_rest(this.path+"/"+n.metadataPrefix+"/"+n.set+"/"+n.identifier,{params:e}).catch(function(t){return null})];case 1:return null!==(r=t.sent())?[2,r.data]:[2,null]}})})},t.prototype.oaiMongoQuery=function(s){return __awaiter(this,void 0,void 0,function(){var e,r,n,o,i;return __generator(this,function(t){switch(t.label){case 0:return e=s.query,r=void 0!==e.resumptionToken&&null!==e.resumptionToken&&""!==e.resumptionToken?parseInt(e.resumptionToken):1,(n=[]).push({storage:"regular"}),n.push({openAccess:2}),void 0!==e.from&&null!==e.from&&""!==e.from&&n.push({modifiedAt:{$gt:new Date(e.from).getTime()}}),void 0!==e.until&&null!==e.until&&""!==e.until&&n.push({modifiedAt:{$lte:new Date(e.until).getTime()}}),o={params:{pagesize:config_1.PAGESIZE,page:r,count:!0,sort:{modifiedAt:-1},filter:{$and:n}}},[4,this.fetch_rest(this.path+"/"+e.metadataPrefix+"/"+e.set,o)];case 1:return(i=t.sent()).data.resumptionToken=r,[2,i.data]}})})},t}(httpRequest_1.default);exports.default=vuejxServiceControl;