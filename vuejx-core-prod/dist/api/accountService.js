"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(s,a,c,u){return new(c=c||Promise)(function(e,t){function n(e){try{o(u.next(e))}catch(e){t(e)}}function r(e){try{o(u.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(n,r)}o((u=u.apply(s,a||[])).next())})},__generator=this&&this.__generator||function(n,r){var o,s,a,e,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,s&&(a=2&t[0]?s.return:t[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,t[1])).done)return a;switch(s=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,s=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){c.label=t[1];break}if(6===t[0]&&c.label<a[1]){c.label=a[1],a=t;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(t);break}a[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],s=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var httpRequest_1=require("./httpRequest"),config_1=require("../config"),crypto=require("crypto"),config_2=require("../config"),ObjectId=require("mongodb").ObjectId,accountServiceControl=function(n){function e(e){var t=n.call(this,config_1.PROJECT_SERVICE_HOST)||this;return t.path=""+config_1.PROJECT_SERVICE_HOST,t.pathSecure=""+config_1.SECURITY_SERVICE_HOST,t}return __extends(e,n),e.prototype.updateUser=function(o){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return t={status:200,msg:""},(n={}).roles=o.roles,n.scope=o.scope,n.username=o.username,n.password=crypto.createHash("sha256").update(o.newPass).digest("hex"),[4,config_2.getClient().db("oauth2").collection("users").findOne({username:o.username})];case 1:return null!=(r=e.sent())?[3,3]:[4,config_2.getClient().db("oauth2").collection("users").insertOne({username:o.username,password:crypto.createHash("sha256").update(o.newPass).digest("hex"),scope:"guest",roles:o.roles})];case 2:return e.sent(),[3,6];case 3:return r.password!==crypto.createHash("sha256").update(o.oldPass).digest("hex")?[3,5]:[4,config_2.getClient().db("oauth2").collection("users").updateOne({_id:new ObjectId(r._id)},{$set:n})];case 4:return e.sent(),t.status=200,t.msg="ok",[3,6];case 5:t={status:409,msg:"Password not match."},e.label=6;case 6:return[4,config_2.getClient().db("oauth2").collection("oauthclients").findOne({name:o.username})];case 7:return null!=e.sent()?[3,9]:null==r?[3,9]:[4,config_2.getClient().db("oauth2").collection("oauthclients").insertOne({name:o.username,clientId:crypto.createHash("md5").update(crypto.randomBytes(16)).digest("hex"),clientSecret:crypto.createHash("sha256").update(crypto.randomBytes(32)).digest("hex"),redirectUris:["/oauth/callback"],grants:["authorization_code","password","refresh_token"],scope:o.username,user:r._id})];case 8:e.sent(),e.label=9;case 9:return[2,t]}})})},e}(httpRequest_1.default);exports.default=accountServiceControl;